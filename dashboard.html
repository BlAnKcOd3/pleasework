<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Your Dashboard</title>
    <!-- We'll use Tailwind CSS for quick, modern styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* A simple Inter font, similar to Firebase's console */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">

    <div class="w-full max-w-lg p-8 space-y-6 bg-white rounded-xl shadow-lg text-center">
        
        <h2 class="text-3xl font-bold text-gray-900">Welcome!</h2>
        <p class="text-lg text-gray-700">You are logged in as: <span id="userEmail" class="font-medium text-blue-600">...</span></p>

        <!-- Spacer -->
        <hr class="my-6 border-gray-300">

        <!-- Protected Action -->
        <div class="space-y-3">
             <h3 class="text-xl font-medium text-gray-900">Server Test</h3>
             <p class="text-sm text-gray-600">You can now test accessing a protected route on our Express server.</p>
            <button id="protectedBtn" class="w-full px-4 py-2 font-medium text-white bg-blue-600 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                Access Protected Route
            </button>
            <button id="logoutBtn" class="w-full px-4 py-2 mt-4 font-medium text-blue-600 bg-blue-50 rounded-md hover:bg-blue-100 focus:outline-none focus:ring-2 focus:ring-blue-400 focus:ring-offset-2">
                Logout
            </button>
            <a href="listing.html">
                <button class="w-full px-4 py-2 mt-4 font-medium text-white bg-pink-500 rounded-md hover:bg-pink-600 focus:outline-none focus:ring-2 focus:ring-pink-400 focus:ring-offset-2">
                    Create Listing
                </button>
            </a>
        </div>

        <!-- Message Area -->
        <div id="message" class="p-3 text-center rounded-md text-sm"></div>

    </div>

    <!-- Firebase Client SDK -->
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { 
            getAuth, 
            onAuthStateChanged,
            signOut,
            getIdToken
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

        // --- IMPORTANT ---
        // This MUST be the same config object as in your index.html
        const firebaseConfig = {
            apiKey: "AIzaSyBJJYUOM8EBEuT39DX2F_HtxgEbHDRH-Zc",
            authDomain: "deanzahacks11-21-2025.firebaseapp.com",
            projectId: "deanzahacks11-21-2025",
            storageBucket: "deanzahacks11-21-2025.firebasestorage.app",
            messagingSenderId: "253702257130",
            appId: "1:253702257130:web:9ea8e3ee1bd291f1801a93",
            measurementId: "G-5B84R81S31"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);

        // --- Element References ---
        const userEmailSpan = document.getElementById('userEmail');
        const protectedBtn = document.getElementById('protectedBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const messageDiv = document.getElementById('message');

        const expressServerUrl = 'http://localhost:3000'; // Your Express server URL
        let currentIdToken = null; // Store the user's ID token

        // --- Functions ---

        // Show messages to the user
        function showMessage(text, type = 'info') {
            messageDiv.textContent = text;
            messageDiv.classList.remove('bg-red-100', 'text-red-700', 'bg-green-100', 'text-green-700', 'bg-blue-100', 'text-blue-700');

            if (type === 'error') {
                messageDiv.classList.add('bg-red-100', 'text-red-700');
            } else if (type === 'success') {
                messageDiv.classList.add('bg-green-100', 'text-green-700');
            } else {
                 messageDiv.classList.add('bg-blue-100', 'text-blue-700');
            }
        }

        // Handle Logout
        async function handleLogout() {
            try {
                await signOut(auth);
                // No need to show a message, the auth listener will redirect us
            } catch (error) {
                showMessage(`Error: ${error.message}`, 'error');
                console.error('Logout error:', error);
            }
        }
        
        // Access Protected Route
        async function accessProtected() {
            if (!currentIdToken) {
                showMessage('You must be logged in to do that.', 'error');
                return;
            }

            showMessage('Accessing server... please wait.', 'info');

            try {
                const response = await fetch(`${expressServerUrl}/protected-route`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${currentIdToken}` // Send the token in the header
                    }
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.message || 'Server responded with an error');
                }

                showMessage(`Server says: "${data.message}"`, 'success');
            } catch (error) {
                showMessage(`Error: ${error.message}`, 'error');
                console.error('Protected route error:', error);
            }
        }

        // --- Auth State ---
        // Listen for changes in authentication state (login, logout)
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // User is signed in
                userEmailSpan.textContent = user.email; // Show their email
                try {
                    currentIdToken = await getIdToken(user); // Get the ID token
                    protectedBtn.disabled = false;
                } catch (error) {
                    console.error('Error getting ID token:', error);
                    showMessage('Error getting user session.', 'error');
                }
                
            } else {
                // User is signed out
                // If they are on this page and not logged in, redirect to login page
                console.log('User is not logged in. Redirecting to index.html');
                window.location.href = 'index.html';
            }
        });

        // --- Event Listeners ---
        logoutBtn.addEventListener('click', handleLogout);
        protectedBtn.addEventListener('click', accessProtected);

    </script>
</body>
</html>