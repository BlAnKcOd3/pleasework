<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title id="pageTitle">Browse Listings - De Anza Marketplace</title>
  <link rel="icon" href="https://i.ibb.co/wNYjZG9k/Image-11-21-25-at-2-05-PM.png" type="image/png">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    /* --- BASE STYLES --- */
    body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background-color: #f8f9fa; color: #333; display: flex; flex-direction: column; min-height: 100vh;}
    * { box-sizing: border-box; }
    a { text-decoration: none; color: inherit; }

    /* Header */
    .header { background: white; box-shadow: 0 4px 20px rgba(0,0,0,0.04); position: sticky; top: 0; z-index: 100; padding: 15px 20px; }
    .header-inner { max-width: 1200px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; }
    .header-title { font-size: 1.4rem; color: #6e0b0f; font-weight: 800; margin-left: 10px; letter-spacing: -0.5px; }
    .sell-btn { background: #6e0b0f; color: white; padding: 10px 28px; border-radius: 30px; font-weight: 600; text-decoration: none; transition: transform 0.2s; box-shadow: 0 4px 10px rgba(110, 11, 15, 0.3); }
    .sell-btn:hover { transform: translateY(-2px); }

    /* Container */
    .container { flex-grow: 1; max-width: 1200px; margin: 40px auto; padding: 0 20px; }
    .page-title { font-size: 2.2rem; margin: 0 0 8px 0; color: #111; font-weight: 800; letter-spacing: -1px; }
    .page-subtitle { margin: 0 0 40px 0; color: #666; font-size: 1.1rem; }

    /* Filter Bar */
    .filters-wrapper {
      background: white; padding: 15px; border-radius: 16px;
      box-shadow: 0 8px 30px rgba(0,0,0,0.05); margin-bottom: 40px;
      display: flex; gap: 10px; align-items: center; flex-wrap: wrap; border: 1px solid #f0f0f0;
    }
    .search-box { flex-grow: 1; position: relative; min-width: 240px; }
    .search-box i { position: absolute; left: 18px; top: 50%; transform: translateY(-50%); color: #999; }
    .search-box input {
      width: 100%; padding: 14px 20px 14px 45px; border-radius: 12px;
      border: 2px solid transparent; background: #f9f9f9; font-size: 1rem; outline: none; transition: all 0.2s;
    }
    .search-box input:focus { background: white; border-color: #ebc034; box-shadow: 0 0 0 4px rgba(235, 192, 52, 0.1); }
    .filter-select { padding: 14px 24px; border-radius: 12px; border: 1px solid #eee; background: white; font-size: 0.95rem; cursor: pointer; outline: none; font-weight: 500; }
    .btn-filter { background: #333; color: white; padding: 14px 30px; border: none; border-radius: 12px; font-weight: 600; cursor: pointer; transition: background 0.2s; }
    .btn-filter:hover { background: #6e0b0f; }
    
    /* Responsive filter adjustments */
    @media (max-width: 768px) {
        .filters-wrapper { flex-direction: column; align-items: stretch; }
        .filter-select, .search-box, .btn-filter { width: 100%; max-width: none; }
    }

    /* Grid */
    .listings-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 30px;
      padding-bottom: 80px;
    }
    #loading-indicator {
        grid-column: 1 / -1;
        text-align: center;
        padding: 40px;
        font-size: 1.2em;
        color: #6e0b0f;
    }
    .centered-message {
        grid-column: 1 / -1;
        text-align: center;
        padding: 40px;
        color: #888;
    }

    /* Card */
    .card {
      background: white; border-radius: 20px; overflow: hidden;
      transition: all 0.3s ease; border: 1px solid #f0f0f0;
      box-shadow: 0 4px 10px rgba(0,0,0,0.03);
      display: flex; flex-direction: column; cursor: pointer; position: relative;
    }
    .card:hover { transform: translateY(-8px); box-shadow: 0 20px 40px rgba(0,0,0,0.1); border-color: transparent; }
    
    .img-frame {
      height: 240px; width: 100%; background: #f4f4f4;
      display: flex; align-items: center; justify-content: center; overflow: hidden; position: relative;
    }
    .img-frame img { width: 100%; height: 100%; object-fit: cover; transition: transform 0.5s; }
    .card:hover .img-frame img { transform: scale(1.05); }
    
    .cat-badge {
      position: absolute; top: 15px; left: 15px;
      background: rgba(255,255,255,0.9); color: #333; padding: 6px 12px;
      border-radius: 30px; font-size: 0.7rem; text-transform: capitalize; font-weight: 800;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1); letter-spacing: 0.5px;
    }

    .card-body { padding: 20px; display: flex; flex-direction: column; flex: 1; }
    .card-title { font-size: 1.1rem; font-weight: 700; color: #111; margin: 0 0 8px 0; line-height: 1.4; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .card-desc { font-size: 0.9rem; color: #777; margin-bottom: 20px; height: 40px; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; }
    .card-footer { margin-top: auto; display: flex; justify-content: space-between; align-items: center; border-top: 1px solid #f5f5f5; padding-top: 15px; }
    .price { font-size: 1.2rem; font-weight: 800; color: #6e0b0f; }
    .btn-view { background: #f4f4f4; color: #333; border: none; padding: 8px 16px; border-radius: 8px; font-weight: 600; cursor: pointer; transition: background 0.2s; }
    .card:hover .btn-view { background: #ebc034; }

    /* --- MODAL STYLES --- */
    .modal-overlay {
      display: none;
      position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.7); z-index: 2000;
      align-items: center; justify-content: center;
      backdrop-filter: blur(8px);
      animation: fadeIn 0.3s ease-out;
    }
    
    .modal-content {
      background: white; width: 95%; max-width: 900px;
      border-radius: 24px; overflow: hidden;
      display: flex; flex-direction: column;
      box-shadow: 0 30px 60px rgba(0,0,0,0.4);
      animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1);
      position: relative;
    }
    
    @media(min-width: 768px) {
      .modal-content { flex-direction: row; height: 550px; }
    }

    /* Image Side */
    .modal-img-col {
      flex: 1.2; background: #f8f8f8; position: relative;
      display: flex; align-items: center; justify-content: center;
      overflow: hidden;
    }
    .modal-img-col img { width: 100%; height: 100%; object-fit: cover; }
    
    /* Close Button */
    .close-btn {
      position: absolute; top: 20px; left: 20px;
      background: rgba(255,255,255,0.9); border-radius: 50%; width: 40px; height: 40px;
      border: none; cursor: pointer; font-size: 1.1rem; color: #333;
      display: flex; align-items: center; justify-content: center;
      box-shadow: 0 4px 15px rgba(0,0,0,0.15); z-index: 10; transition: transform 0.2s;
    }
    .close-btn:hover { transform: scale(1.1); }

    /* Info Side */
    .modal-info-col {
      flex: 1; padding: 40px; display: flex; flex-direction: column;
      overflow-y: auto; background: white;
    }

    .modal-cat { color: #888; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1.5px; font-weight: 700; margin-bottom: 10px; }
    .modal-title-h2 { font-size: 2.2rem; margin: 0 0 10px 0; line-height: 1.1; color: #111; font-weight: 800; letter-spacing: -0.5px; }
    .modal-price { font-size: 2rem; color: #6e0b0f; font-weight: 800; margin-bottom: 25px; }
    
    /* Seller Badge */
    .seller-info {
      display: flex; align-items: center; gap: 15px; padding: 12px 16px;
      background: #fdfcf5; border: 1px solid #eee; 
      border-radius: 12px; margin-bottom: 25px;
    }
    .seller-avatar { 
      width: 45px; height: 45px; background: #ebc034; 
      border-radius: 50%; display: flex; align-items: center; 
      justify-content: center; font-weight: bold; color: #333; font-size: 1.2rem;
    }
    .seller-text h4 { margin: 0; font-size: 0.95rem; color: #333; }
    .seller-text span { font-size: 0.8rem; color: #2ecc71; font-weight: 600; display: flex; align-items: center; gap: 4px; }

    .modal-desc { font-size: 1rem; line-height: 1.6; color: #555; margin-bottom: 30px; flex: 1; white-space: pre-wrap;}
    
    /* Action Button (Now "Show Contact Info") */
    .btn-msg {
      width: 100%; background: #6e0b0f; color: white; border: none;
      padding: 16px; border-radius: 14px; font-size: 1.1rem; font-weight: 700;
      cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px;
      text-decoration: none; transition: all 0.2s;
      box-shadow: 0 8px 20px rgba(110, 11, 15, 0.2);
    }
    .btn-msg:hover { background: #50080b; transform: translateY(-2px); }

    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes slideUp { from { transform: translateY(40px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

    /* Footer */
    .site-footer {
        text-align: center;
        padding: 20px;
        border-top: 1px solid #eee;
        color: #888;
        font-size: 0.9rem;
    }
    .footer-link { color: #6e0b0f; text-decoration: underline; margin: 0 10px; }
  </style>
</head>
<body>

  <header class="header">
    <div class="header-inner">
      <a href="marketplace.html" style="text-decoration:none; display:flex; align-items:center;">
        <img src="https://i.ibb.co/wNYjZG9k/Image-11-21-25-at-2-05-PM.png" class="logo" alt="Logo" style="height:45px;">
        <span class="header-title">De Anza Marketplace</span>
      </a>
      <a href="sell.html" class="sell-btn" id="sellButton"><i class="fas fa-plus"></i> Sell</a>
    </div>
  </header>

  <div class="container">
    <h2 class="page-title">Browse Listings</h2>
    <p class="page-subtitle">Find textbooks, electronics, and gear from other students.</p>

    <div class="filters-wrapper">
      <div class="search-box">
        <i class="fas fa-search"></i>
        <input id="search-input" type="text" placeholder="Search items...">
      </div>
      
      <select id="filter-category" class="filter-select">
          <option value="">All Categories</option>
          <option value="textbooks">Textbooks</option>
          <option value="study-supplies">Study Supplies</option>
          <option value="electronics">Electronics</option>
          <option value="bikes">Bikes & Outdoors</option>
          <option value="housing">Housing & Roommates</option>
          <option value="services">Services & Rentals</option>
          <option value="jobs">Student Jobs</option>
          <option value="events">Events & Campus Activities</option>
          <option value="misc">Other/Misc</option>
      </select>
      
      <select id="filter-price" class="filter-select">
          <option value="">Any Price</option>
          <option value="free">Free</option>
          <option value="1-50">$1 - $50</option>
          <option value="51-200">$51 - $200</option>
          <option value="201-inf">$201+</option>
      </select>
      
      <button id="btn-apply" class="btn-filter">Apply</button>
    </div>

    <div id="loading-indicator">Loading listings...</div>
    <div id="product-grid" class="listings-grid">
      </div>
  </div>

  <div id="listing-modal" class="modal-overlay" aria-hidden="true">
    <div class="modal-content" onclick="event.stopPropagation()">
      
      <div class="modal-img-col">
        <button class="close-btn" id="listing-modal-close"><i class="fas fa-times"></i></button>
        <img id="modal-image" src="" alt="Product">
      </div>

      <div class="modal-info-col">
        <div id="modal-category" class="modal-cat">Category</div>
        <h2 id="modal-title" class="modal-title-h2">Product Title</h2>
        <div id="modal-price" class="modal-price">$0.00</div>
        
        <div class="seller-info">
          <div class="seller-avatar"><i class="fas fa-user"></i></div>
          <div class="seller-text">
            <h4>Sold by <span id="modal-seller-id">Student</span></h4>
            <span><i class="fas fa-check-circle"></i> Verified Student ID</span>
          </div>
        </div>

        <p id="modal-description" class="modal-desc">Description goes here...</p>
        
        <button id="modal-action" class="btn-msg">
          <i class="fas fa-phone-alt"></i> Show Contact Info
        </button>
      </div>
    </div>
  </div>

  <footer class="site-footer">
    &copy; 2025 De Anza Marketplace 
    <a href="index.html" class="footer-link">Logout</a>
  </footer>

  <script src="firebase_config.js"></script>

  <script type="module">
    // Firebase imports (v11)
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, query, where, onSnapshot, orderBy, doc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    
    // Global Firebase instances
    let app, auth, db, userId = null;
    let isAuthReady = false;
    setLogLevel('Debug'); // Set Firestore log level to debug for better console feedback

    // --- Firebase Configuration (Fallback/Default) ---
    // Note: The global __firebase_config is used if available, otherwise this fallback is used.
    let firebaseConfig = {
        apiKey: "AIzaSyBJJYUOM8EBEuT39DX2F_HtxgEbHDRH-Zc",
        authDomain: "deanzahacks11-21-2025.firebaseapp.com",
        projectId: "deanzahacks11-21-2025",
        storageBucket: "deanzahacks11-21-2025.firebasestorage.app",
        messagingSenderId: "253702257130",
        appId: "1:253702257130:web:9ea8e3ee1bd291f1801a93",
        measurementId: "G-5B84R81S31"
    };

    const appId = 'default-app-id'; // Used to construct the listings path

    // --- DOM Elements ---
    const productGrid = document.getElementById('product-grid');
    const loadingIndicator = document.getElementById('loading-indicator');
    const filterCategory = document.getElementById('filter-category');
    const filterPrice = document.getElementById('filter-price');
    const searchInput = document.getElementById('search-input');
    const pageTitle = document.getElementById('pageTitle');
    
    // State for current filters
    let currentCategory = '';
    let currentPriceRange = '';
    let currentSearchTerm = '';
    
    // --- Utility Functions ---

    function renderListings(listings) {
        productGrid.innerHTML = ''; // Clear previous listings
        loadingIndicator.style.display = 'none';

        if (listings.length === 0) {
            productGrid.innerHTML = '<p class="centered-message">No listings found matching your criteria.</p>';
            return;
        }

        listings.forEach(listing => {
            const card = document.createElement('div');
            card.className = 'card';
            const imageUrl = listing.image || 'https://placehold.co/400x300/6e0b0f/f8f9fa?text=No+Image';

            card.dataset.id = listing.id;
            card.onclick = () => openListingModal(listing); // Call modal on click

            // Clean up category for display (e.g., 'study-supplies' -> 'Study Supplies')
            const displayCategory = listing.category.charAt(0).toUpperCase() + listing.category.slice(1).replace('-', ' ');

            card.innerHTML = `
                <div class="img-frame">
                    <span class="cat-badge">${displayCategory}</span>
                    <img src="${imageUrl}" onerror="this.onerror=null;this.src='https://placehold.co/400x300/6e0b0f/f8f9fa?text=Image+Unavailable';" alt="${listing.title}" />
                </div>
                <div class="card-body">
                    <div class="card-title">${listing.title}</div>
                    <div class="card-desc">${listing.description || 'No description.'}</div>
                    <div class="card-footer">
                        <div class="price">${listing.price === 0 ? 'FREE' : `$${(listing.price || 0).toFixed(2)}`}</div>
                        <button class="btn-view">View</button>
                    </div>
                </div>
            `;
            productGrid.appendChild(card);
        });
    }
    
    // --- Filter and Search Logic ---
    
    function fetchListings() {
        if (!isAuthReady || !db) return;

        loadingIndicator.textContent = 'Loading listings...';
        loadingIndicator.style.display = 'block';
        productGrid.innerHTML = '';
        
        const listingsRef = collection(db, `artifacts/${appId}/public/data/listings`);
        let conditions = [];
        
        // 1. Category Filter (Server-side, equality check)
        if (currentCategory) {
            conditions.push(where('category', '==', currentCategory));
        }
        
        // 2. Combine conditions and order by creation date
        const q = query(listingsRef, ...conditions, orderBy('createdAt', 'desc'));
        
        const unsubscribe = onSnapshot(q, (snapshot) => {
            let listings = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

            // 3. Client-Side Price Filter
            if (currentPriceRange) {
                
                listings = listings.filter(listing => {
                    const price = listing.price || 0; // Default to 0 if price is missing/null

                    if (currentPriceRange === 'free') {
                        return price === 0;
                    }
                    
                    const [min, max] = currentPriceRange.split('-');
                    const minPrice = parseFloat(min);
                    const maxPrice = max === 'inf' ? Infinity : parseFloat(max);

                    // Apply range filter
                    return price >= minPrice && price <= maxPrice;
                });
            }


            // 4. Client-Side Search Filter
            if (currentSearchTerm) {
                const searchLower = currentSearchTerm.toLowerCase();
                listings = listings.filter(listing => 
                    (listing.title && listing.title.toLowerCase().includes(searchLower)) || 
                    (listing.description && listing.description.toLowerCase().includes(searchLower))
                );
            }
            
            // Keep a reference to the latest listings so click handlers can look them up
            window.currentListings = listings;
            renderListings(listings);
        }, (error) => {
            console.error("Error listening to listings:", error);
            loadingIndicator.textContent = `Error loading listings: ${error.message}`;
        });
        
        // Clean up old subscription if it exists
        if (window.unsubscribeListings) {
            window.unsubscribeListings();
        }
        window.unsubscribeListings = unsubscribe; // Store new unsubscribe function
    }
    
    function handleFilterChange() {
        currentCategory = filterCategory.value;
        currentPriceRange = filterPrice.value;
        currentSearchTerm = searchInput.value.trim();
        fetchListings();
    }

    // --- Initialization Helpers ---
    
    function getInitialFilters() {
        const params = new URLSearchParams(window.location.search);
        const categoryParam = params.get('category');
        const searchParam = params.get('search');

        if (categoryParam) {
            currentCategory = categoryParam;
            filterCategory.value = categoryParam;
            // Update page title to reflect the category filter
            pageTitle.textContent = `Listings - ${categoryParam.charAt(0).toUpperCase() + categoryParam.slice(1).replace('-', ' ')}`;
        }
        if (searchParam) {
            currentSearchTerm = searchParam;
            searchInput.value = searchParam;
        }
    }
    
    async function setupFirebaseAndListeners() {
        getInitialFilters();

        if (!firebaseConfig.apiKey) {
            console.error("Firebase configuration is missing.");
            loadingIndicator.textContent = 'App configuration error. Cannot connect to services.';
            return;
        }

        // Initialize Firebase
        app = initializeApp(firebaseConfig);
        auth = getAuth(app);
        db = getFirestore(app);

        // Authentication setup
        // Uses the initialAuthToken if available, otherwise signs in anonymously
        onAuthStateChanged(auth, (user) => {
            isAuthReady = true;
            if (user) {
                userId = user.uid;
            } else {
                userId = null;
                signInAnonymously(auth).catch(e => {
                     console.error("Anonymous Sign-In failed:", e);
                });
            }
            // Call fetchListings only after the initial auth check is complete
            fetchListings(); 
        });
        
        // --- Event Listeners for Filters/Search ---
        filterCategory.addEventListener('change', handleFilterChange);
        filterPrice.addEventListener('change', handleFilterChange);
        searchInput.addEventListener('input', handleFilterChange); 
        document.getElementById('btn-apply').addEventListener('click', handleFilterChange); // Manual apply button

        // --- Event Listeners for Navigation ---
        document.getElementById('sellButton').addEventListener('click', (e) => {
             e.preventDefault();
             window.location.href = 'sell.html'; 
        });
        
        window.addEventListener('beforeunload', () => {
            if (window.unsubscribeListings) {
                window.unsubscribeListings();
            }
        });
    }
    
    // --- Modal & Interaction Helpers ---

    function openListingModal(listing) {
        const modal = document.getElementById('listing-modal');
        const imgUrl = listing.image || 'https://placehold.co/800x600/6e0b0f/f8f9fa?text=No+Image';

        document.getElementById('modal-image').src = imgUrl;
        document.getElementById('modal-title').textContent = listing.title || '';
        document.getElementById('modal-category').textContent = listing.category ? listing.category.charAt(0).toUpperCase() + listing.category.slice(1).replace('-', ' ') : '';
        document.getElementById('modal-description').textContent = listing.description || 'No description provided.';
        document.getElementById('modal-price').textContent = listing.price === 0 ? 'FREE' : `$${(listing.price || 0).toFixed(2)}`;
        // Display seller ID (first 8 chars) for verification, but not full contact info yet
        document.getElementById('modal-seller-id').textContent = listing.userId ? listing.userId.substring(0, 8) + '...' : 'N/A';
        
        // Attach contact info to the action button for click handler
        const actionBtn = document.getElementById('modal-action');
        actionBtn.dataset.id = listing.id;
        actionBtn.dataset.contactEmail = listing.contactEmail || 'Not provided';
        actionBtn.dataset.contactPhone = listing.contactPhone || 'Not provided';
        actionBtn.textContent = 'Show Contact Info';

        modal.style.display = 'flex';
        modal.setAttribute('aria-hidden', 'false');
    }

    function closeListingModal() {
        const modal = document.getElementById('listing-modal');
        modal.style.display = 'none';
        modal.setAttribute('aria-hidden', 'true');
    }

    // Modal close handlers
    document.getElementById('listing-modal-close').addEventListener('click', closeListingModal);
    
    // Close modal when clicking on the overlay (parent)
    document.getElementById('listing-modal').addEventListener('click', (e) => {
        if (e.target.id === 'listing-modal') {
            closeListingModal();
        }
    });


    // Primary modal action: show seller contact info in a popup
    document.getElementById('modal-action').addEventListener('click', (e) => {
        const email = e.target.dataset.contactEmail;
        const phone = e.target.dataset.contactPhone;

        // Simple popup with contact info
        alert(`Contact Information:\n\nEmail: ${email}\nPhone: ${phone}`);
    });

    // --- Initialization ---
    window.onload = setupFirebaseAndListeners;

  </script>
</body>
</html>