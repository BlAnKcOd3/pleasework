<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Login - De Anza Marketplace</title>
    <style>
        body { font-family: Arial, sans-serif; background: #f7f7f7; margin: 0; padding: 0; }
        .container { max-width: 400px; margin: 60px auto; background: #fff; padding: 32px; border-radius: 8px; box-shadow: 0 2px 8px #ccc; }
        h1 { text-align: center; color: #2d6a4f; }
        .desc { font-size:1em; color:#555; margin-bottom:16px; text-align:center; }
        .tabs { display: flex; gap: 8px; margin-bottom: 20px; border-bottom: 2px solid #e0e0e0; }
        .tab { flex: 1; padding: 12px; background: transparent; border: none; border-bottom: 3px solid transparent; cursor: pointer; font-size: 1em; color: #666; }
        .tab.active { color: #2d6a4f; border-bottom-color: #2d6a4f; font-weight: bold; }
        .tab:hover { color: #2d6a4f; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        form { display: flex; flex-direction: column; gap: 12px; }
        input[type="text"], input[type="email"], input[type="tel"], input[type="password"] { padding: 10px; border-radius: 4px; border: 1px solid #ccc; }
        input.error { border-color: #d90429; }
        button { background: #2d6a4f; color: #fff; border: none; border-radius: 4px; padding: 10px 0; cursor: pointer; font-size: 1em; }
        button:hover { background: #40916c; }
        .warn { color: #d90429; font-size:1em; font-weight:bold; margin-top:8px; text-align:center; }
        .error-msg { color: #d90429; font-size: 0.9em; margin-top: -8px; display: none; }
        .error-msg.show { display: block; }
        .success-msg { color: #2d6a4f; font-size: 0.9em; margin-top: -8px; display: none; }
        .success-msg.show { display: block; }
        .login-hint { font-size: 0.85em; color: #666; margin-top: -8px; }
    </style>
</head>
<body>
    <nav style="max-width:400px;margin:24px auto 0 auto;text-align:center;">
        <a href="index.html">Firestore Demo</a> |
        <a href="wishboard.html">Marketplace</a> |
        <a href="testfile.html">Home</a>
    </nav>
    <div class="container">
        <h1>De Anza Marketplace</h1>
        <div class="desc">Welcome to the De Anza Marketplace! Please login or register to access the marketplace.</div>
        
        <!-- Tabs -->
        <div class="tabs">
            <button class="tab active" id="loginTab">Login</button>
            <button class="tab" id="registerTab">Register</button>
        </div>
        
        <!-- Login Form -->
        <div class="tab-content active" id="loginForm">
            <form id="loginFormElement">
                <input type="tel" id="loginIdNumber" placeholder="Enter your ID number (8 digits)" maxlength="8" pattern="[0-9]{8}">
                <div class="login-hint">OR</div>
                <input type="email" id="loginEmail" placeholder="Enter your email address">
                <div class="error-msg" id="loginIdError">ID number must be exactly 8 digits (numbers only)</div>
                <div class="error-msg" id="loginEmailError">Please enter a valid email address</div>
                <input type="password" id="loginPassword" placeholder="Enter your password" required>
                <div class="error-msg" id="loginFormError"></div>
                <div class="success-msg" id="loginFormSuccess"></div>
                <button type="submit" id="loginSubmitBtn">Login</button>
            </form>
        </div>
        
        <!-- Register Form -->
        <div class="tab-content" id="registerForm">
            <form id="registerFormElement">
                <input type="tel" id="registerIdNumber" placeholder="Enter your ID number (8 digits)" required maxlength="8" pattern="[0-9]{8}">
                <div class="error-msg" id="registerIdError">ID number must be exactly 8 digits (numbers only)</div>
                <input type="text" id="registerUsername" placeholder="Enter your name" required maxlength="32">
                <input type="email" id="registerEmail" placeholder="Enter your email address" required>
                <div class="error-msg" id="registerEmailError">Please enter a valid email address</div>
                <input type="password" id="registerPassword" placeholder="Enter your password" required>
                <div class="error-msg" id="registerPasswordError">Passwords do not match</div>
                <div class="error-msg" id="registerFormError"></div>
                <div class="success-msg" id="registerFormSuccess"></div>
                <button type="submit" id="registerSubmitBtn">Register</button>
            </form>
        </div>
            </div>
    <script type="module" src="app.js"></script>
    <script type="module">
        // Import Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, query, where, doc, setDoc } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

        // Firebase configuration (same as wishboard.html)
        const firebaseConfig = {
            apiKey: "AIzaSyCO-w3HsDbLVbEk_J7qYEMkrpgUC_CWn54",
            authDomain: "de-anza-marketplace.firebaseapp.com",
            projectId: "de-anza-marketplace",
            storageBucket: "de-anza-marketplace.firebasestorage.app",
            messagingSenderId: "789429114794",
            appId: "1:789429114794:web:f5240be7a6458f50c07dd3",
            measurementId: "G-Z5NSE0RX1N"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const usersRef = collection(db, "users");

        // Simple password hashing (for production, use a proper library like bcrypt on backend)
        async function hashPassword(password) {
            const encoder = new TextEncoder();
            const data = encoder.encode(password);
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        }

        function getDeviceId() {
            const data = [
                navigator.userAgent,
                navigator.language,
                screen.width,
                screen.height,
                screen.colorDepth,
                navigator.platform,
                navigator.hardwareConcurrency
            ].join('|');
            let hash = 0;
            for (let i = 0; i < data.length; i++) {
                hash = ((hash << 5) - hash) + data.charCodeAt(i);
                hash |= 0;
            }
            return 'dev-' + Math.abs(hash);
        }

        // Validate ID number
        function validateIdNumber(idNumber) {
            const idRegex = /^[0-9]{8}$/;
            return idRegex.test(idNumber);
        }

        // Validate email
        function validateEmail(email) {
            return email.includes('@') && email.length > 3;
        }

        // Tab switching
        const loginTab = document.getElementById('loginTab');
        const registerTab = document.getElementById('registerTab');
        const loginFormDiv = document.getElementById('loginForm');
        const registerFormDiv = document.getElementById('registerForm');
        
        loginTab.addEventListener('click', function() {
            loginTab.classList.add('active');
            registerTab.classList.remove('active');
            loginFormDiv.classList.add('active');
            registerFormDiv.classList.remove('active');
        });
        
        registerTab.addEventListener('click', function() {
            registerTab.classList.add('active');
            loginTab.classList.remove('active');
            registerFormDiv.classList.add('active');
            loginFormDiv.classList.remove('active');
        });
        
        // Login form elements
        const loginIdInput = document.getElementById('loginIdNumber');
        const loginEmailInput = document.getElementById('loginEmail');
        const loginPasswordInput = document.getElementById('loginPassword');
        const loginIdError = document.getElementById('loginIdError');
        const loginEmailError = document.getElementById('loginEmailError');
        const loginFormError = document.getElementById('loginFormError');
        const loginFormSuccess = document.getElementById('loginFormSuccess');
        
        // Register form elements
        const registerIdInput = document.getElementById('registerIdNumber');
        const registerUsernameInput = document.getElementById('registerUsername');
        const registerEmailInput = document.getElementById('registerEmail');
        const registerPasswordInput = document.getElementById('registerPassword');
        const registerIdError = document.getElementById('registerIdError');
        const registerEmailError = document.getElementById('registerEmailError');
        const registerPasswordError = document.getElementById('registerPasswordError');
        const registerFormError = document.getElementById('registerFormError');
        const registerFormSuccess = document.getElementById('registerFormSuccess');
        
        // Track if password is confirmed
        let passwordConfirmed = false;
        let originalPassword = '';
        
        // Login ID number validation
        loginIdInput.addEventListener('input', function(e) {
            const value = e.target.value;
            e.target.value = value.replace(/[^0-9]/g, '');
            if (e.target.value.length > 0 && !validateIdNumber(e.target.value)) {
                loginIdInput.classList.add('error');
                loginIdError.classList.add('show');
            } else {
                loginIdInput.classList.remove('error');
                loginIdError.classList.remove('show');
            }
        });
        
        // Login email validation
        loginEmailInput.addEventListener('input', function(e) {
            const value = e.target.value.trim();
            if (value.length > 0 && !validateEmail(value)) {
                loginEmailInput.classList.add('error');
                loginEmailError.classList.add('show');
            } else {
                loginEmailInput.classList.remove('error');
                loginEmailError.classList.remove('show');
            }
        });
        
        // Register ID number validation
        registerIdInput.addEventListener('input', function(e) {
            const value = e.target.value;
            e.target.value = value.replace(/[^0-9]/g, '');
            if (e.target.value.length > 0 && !validateIdNumber(e.target.value)) {
                registerIdInput.classList.add('error');
                registerIdError.classList.add('show');
            } else {
                registerIdInput.classList.remove('error');
                registerIdError.classList.remove('show');
            }
        });
        
        // Register email validation
        registerEmailInput.addEventListener('input', function(e) {
            const value = e.target.value.trim();
            if (value.length > 0 && !validateEmail(value)) {
                registerEmailInput.classList.add('error');
                registerEmailError.classList.add('show');
            } else {
                registerEmailInput.classList.remove('error');
                registerEmailError.classList.remove('show');
            }
        });
        
        // Reset password confirmation when password changes
        registerPasswordInput.addEventListener('input', function(e) {
            passwordConfirmed = false;
            registerPasswordInput.classList.remove('error');
            registerPasswordError.classList.remove('show');
        });
        
        // Password confirmation on blur (ONLY for register form)
        registerPasswordInput.addEventListener('blur', function(e) {
            // Double-check we're in the register form (not login)
            if (e.target.id !== 'registerPassword') {
                return;
            }
            
            const password = e.target.value;
            
            // Only prompt if password is not empty and not already confirmed
            if (password.length > 0 && !passwordConfirmed) {
                originalPassword = password;
                
                // Prompt user to re-enter password (ONLY for registration)
                const confirmPassword = prompt('Please re-enter your password to confirm:');
                
                if (confirmPassword === null) {
                    // User cancelled - clear the password field
                    registerPasswordInput.value = '';
                    registerPasswordInput.classList.remove('error');
                    registerPasswordError.classList.remove('show');
                    passwordConfirmed = false;
                    return;
                }
                
                // Compare passwords character by character
                if (password.length !== confirmPassword.length) {
                    // Different lengths - definitely don't match
                    registerPasswordInput.classList.add('error');
                    registerPasswordError.classList.add('show');
                    registerPasswordInput.value = '';
                    passwordConfirmed = false;
                    alert('Passwords do not match. Please try again.');
                    return;
                }
                
                // Compare character by character
                let matches = true;
                for (let i = 0; i < password.length; i++) {
                    if (password[i] !== confirmPassword[i]) {
                        matches = false;
                        break;
                    }
                }
                
                if (matches) {
                    // Passwords match
                    registerPasswordInput.classList.remove('error');
                    registerPasswordError.classList.remove('show');
                    passwordConfirmed = true;
                } else {
                    // Passwords don't match
                    registerPasswordInput.classList.add('error');
                    registerPasswordError.classList.add('show');
                    registerPasswordInput.value = '';
                    passwordConfirmed = false;
                    alert('Passwords do not match. Please try again.');
                }
            }
        });

        // Timeout wrapper helper
        const withTimeout = (promise, timeoutMs) => {
            return Promise.race([
                promise,
                new Promise((_, reject) => 
                    setTimeout(() => reject(new Error('Request timed out. Please check your connection and try again.')), timeoutMs)
                )
            ]);
        };

        // LOGIN FORM HANDLER
        document.getElementById('loginFormElement').onsubmit = async function(e) {
            e.preventDefault();
            const idNumber = loginIdInput.value.trim();
            const email = loginEmailInput.value.trim();
            const password = loginPasswordInput.value;
            
            // Clear previous messages
            loginFormError.classList.remove('show');
            loginFormSuccess.classList.remove('show');
            loginFormError.textContent = '';
            
            // Must provide either ID number OR email (not both required, but at least one)
            if (!idNumber && !email) {
                loginFormError.textContent = 'Please enter either your ID number or email address';
                loginFormError.classList.add('show');
                return;
            }
            
            // Validate ID number if provided
            if (idNumber && !validateIdNumber(idNumber)) {
                loginIdInput.classList.add('error');
                loginIdError.classList.add('show');
                loginIdInput.focus();
                return;
            }
            
            // Validate email if provided
            if (email && !validateEmail(email)) {
                loginEmailInput.classList.add('error');
                loginEmailError.classList.add('show');
                loginEmailInput.focus();
                return;
            }
            
            if (!password) {
                loginFormError.textContent = 'Password is required';
                loginFormError.classList.add('show');
                return;
            }

            const submitBtn = document.getElementById('loginSubmitBtn');
            const originalText = submitBtn.textContent;
            submitBtn.disabled = true;
            submitBtn.textContent = 'Processing...';
            
            // Safety mechanism: re-enable button after 15 seconds no matter what
            const safetyTimeout = setTimeout(() => {
                console.error('Safety timeout triggered - re-enabling button');
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
                loginFormError.textContent = 'Request took too long. Please check your connection and try again.';
                loginFormError.classList.add('show');
            }, 15000);

            // Add timeout wrapper to prevent infinite hanging
            const withTimeout = (promise, timeoutMs) => {
                return Promise.race([
                    promise,
                    new Promise((_, reject) => 
                        setTimeout(() => reject(new Error('Request timed out. Please check your connection and try again.')), timeoutMs)
                    )
                ]);
            };

            try {
                console.log('Starting login process...');
                
                // Hash the password
                const hashedPassword = await hashPassword(password);
                
                let useFirestore = true;
                let userSnapshot = { empty: true };
                
                // Try Firestore first, but fallback to localStorage if it fails
                try {
                    console.log('Querying Firestore for user...');
                    let userQuery;
                    if (idNumber) {
                        userQuery = query(usersRef, where('idNumber', '==', idNumber));
                    } else {
                        userQuery = query(usersRef, where('email', '==', email));
                    }
                    
                    userSnapshot = await withTimeout(getDocs(userQuery), 5000);
                    console.log('Firestore query completed');
                } catch (firestoreError) {
                    console.warn('Firestore query failed, using localStorage fallback:', firestoreError);
                    useFirestore = false;
                    
                    // Fallback to localStorage
                    const localUsers = JSON.parse(localStorage.getItem('wishboard_users') || '[]');
                    const existingUser = idNumber 
                        ? localUsers.find(u => u.idNumber === idNumber)
                        : localUsers.find(u => u.email === email);
                    
                    if (existingUser) {
                        userSnapshot = { 
                            empty: false, 
                            docs: [{ 
                                id: existingUser.id || existingUser.idNumber, 
                                data: () => existingUser 
                            }] 
                        };
                    }
                }

                // Check if user exists
                if (userSnapshot.empty) {
                    clearTimeout(safetyTimeout);
                    loginFormError.textContent = 'User not found. Please check your ID number or email.';
                    loginFormError.classList.add('show');
                    submitBtn.disabled = false;
                    submitBtn.textContent = originalText;
                    return;
                }

                const userDoc = userSnapshot.docs[0];
                const userData = typeof userDoc.data === 'function' ? userDoc.data() : userDoc;
                const userId = userDoc.id || userData.idNumber;
                
                // Verify password
                if (userData.password === hashedPassword) {
                    // Login successful
                    localStorage.setItem('wishboard_user', userData.username || 'User');
                    localStorage.setItem('wishboard_user_id', userId);
                    localStorage.setItem('wishboard_id_number', userData.idNumber);
                    localStorage.setItem('wishboard_email', userData.email);
                    localStorage.setItem('wishboard_device_id', getDeviceId());
                    
                    clearTimeout(safetyTimeout);
                    loginFormSuccess.textContent = 'Login successful! Redirecting...';
                    loginFormSuccess.classList.add('show');
                    submitBtn.textContent = 'Success! Redirecting...';
                    
                    setTimeout(() => {
                        window.location.href = 'wishboard.html';
                    }, 500);
                } else {
                    clearTimeout(safetyTimeout);
                    loginFormError.textContent = 'Incorrect password';
                    loginFormError.classList.add('show');
                    submitBtn.disabled = false;
                    submitBtn.textContent = originalText;
                }
                
            } catch (error) {
                console.error('Error:', error);
                clearTimeout(safetyTimeout);
                
                let errorMessage = 'An error occurred. Please try again.';
                
                if (error.message) {
                    if (error.message.includes('timeout') || error.message.includes('timed out')) {
                        errorMessage = 'Connection timeout. Please check your connection and try again.';
                    } else {
                        errorMessage = error.message;
                    }
                } else if (error.code) {
                    switch(error.code) {
                        case 'permission-denied':
                            errorMessage = 'Firestore permission denied. Please check Firestore security rules.';
                            break;
                        case 'unavailable':
                            errorMessage = 'Service unavailable. Please check your internet connection.';
                            break;
                        default:
                            errorMessage = 'Error: ' + error.code;
                    }
                }
                
                loginFormError.textContent = errorMessage;
                loginFormError.classList.add('show');
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
            }
        };

        // REGISTER FORM HANDLER
        document.getElementById('registerFormElement').onsubmit = async function(e) {
            e.preventDefault();
            const idNumber = registerIdInput.value.trim();
            const username = registerUsernameInput.value.trim();
            const email = registerEmailInput.value.trim();
            const password = registerPasswordInput.value;
            
            // Clear previous messages
            registerFormError.classList.remove('show');
            registerFormSuccess.classList.remove('show');
            registerFormError.textContent = '';
            
            // Validate all fields are required for registration
            if (!validateIdNumber(idNumber)) {
                registerIdInput.classList.add('error');
                registerIdError.classList.add('show');
                registerIdInput.focus();
                return;
            }
            
            if (!validateEmail(email)) {
                registerEmailInput.classList.add('error');
                registerEmailError.classList.add('show');
                registerEmailInput.focus();
                return;
            }
            
            if (!username || !email || !password) {
                registerFormError.textContent = 'Please fill in all fields';
                registerFormError.classList.add('show');
                return;
            }
            
            // Check if password was confirmed
            if (!passwordConfirmed) {
                registerFormError.textContent = 'Please confirm your password by clicking off the password field';
                registerFormError.classList.add('show');
                registerPasswordInput.focus();
                return;
            }

            const submitBtn = document.getElementById('registerSubmitBtn');
            const originalText = submitBtn.textContent;
            submitBtn.disabled = true;
            submitBtn.textContent = 'Processing...';
            
            // Safety mechanism
            const safetyTimeout = setTimeout(() => {
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
                registerFormError.textContent = 'Request took too long. Please check your connection and try again.';
                registerFormError.classList.add('show');
            }, 15000);

            try {
                console.log('Starting registration process...');
                
                // Hash the password
                const hashedPassword = await hashPassword(password);
                
                let useFirestore = true;
                let idSnapshot = { empty: true };
                let emailSnapshot = { empty: true };
                
                // Check if user already exists
                try {
                    const idQuery = query(usersRef, where('idNumber', '==', idNumber));
                    const emailQuery = query(usersRef, where('email', '==', email));
                    
                    [idSnapshot, emailSnapshot] = await withTimeout(
                        Promise.all([getDocs(idQuery), getDocs(emailQuery)]),
                        5000
                    );
                } catch (firestoreError) {
                    console.warn('Firestore query failed, using localStorage fallback:', firestoreError);
                    useFirestore = false;
                    
                    const localUsers = JSON.parse(localStorage.getItem('wishboard_users') || '[]');
                    const existingUserById = localUsers.find(u => u.idNumber === idNumber);
                    const existingUserByEmail = localUsers.find(u => u.email === email);
                    
                    if (existingUserById) {
                        idSnapshot = { empty: false, docs: [{ id: existingUserById.id, data: () => existingUserById }] };
                    }
                    if (existingUserByEmail) {
                        emailSnapshot = { empty: false, docs: [{ id: existingUserByEmail.id, data: () => existingUserByEmail }] };
                    }
                }

                // Check if ID number is already registered
                if (!idSnapshot.empty) {
                    clearTimeout(safetyTimeout);
                    registerFormError.textContent = 'This ID number is already registered';
                    registerFormError.classList.add('show');
                    submitBtn.disabled = false;
                    submitBtn.textContent = originalText;
                    return;
                }

                // Check if email is already registered
                if (!emailSnapshot.empty) {
                    clearTimeout(safetyTimeout);
                    registerFormError.textContent = 'This email is already registered';
                    registerFormError.classList.add('show');
                    submitBtn.disabled = false;
                    submitBtn.textContent = originalText;
                    return;
                }

                // New user - register
                const userDoc = {
                    idNumber: idNumber,
                    username: username,
                    email: email,
                    password: hashedPassword,
                    createdAt: Date.now()
                };

                let userId;
                
                if (useFirestore) {
                    try {
                        const docRef = await withTimeout(addDoc(usersRef, userDoc), 5000);
                        userId = docRef.id;
                    } catch (firestoreError) {
                        console.warn('Failed to save to Firestore, using localStorage:', firestoreError);
                        useFirestore = false;
                    }
                }
                
                // Save to localStorage (always, as backup)
                if (!useFirestore) {
                    const localUsers = JSON.parse(localStorage.getItem('wishboard_users') || '[]');
                    userId = 'local_' + Date.now();
                    localUsers.push({ ...userDoc, id: userId });
                    localStorage.setItem('wishboard_users', JSON.stringify(localUsers));
                }
                
                localStorage.setItem('wishboard_user', username);
                localStorage.setItem('wishboard_user_id', userId);
                localStorage.setItem('wishboard_id_number', idNumber);
                localStorage.setItem('wishboard_email', email);
                localStorage.setItem('wishboard_device_id', getDeviceId());
                
                clearTimeout(safetyTimeout);
                registerFormSuccess.textContent = 'Registration successful! Redirecting...';
                registerFormSuccess.classList.add('show');
                submitBtn.textContent = 'Success! Redirecting...';
                
                setTimeout(() => {
                    window.location.href = 'wishboard.html';
                }, 1000);
                
            } catch (error) {
                console.error('Error:', error);
                clearTimeout(safetyTimeout);
                
                let errorMessage = 'An error occurred. Please try again.';
                
                if (error.message) {
                    errorMessage = error.message;
                } else if (error.code) {
                    switch(error.code) {
                        case 'permission-denied':
                            errorMessage = 'Firestore permission denied. Please check Firestore security rules.';
                            break;
                        case 'unavailable':
                            errorMessage = 'Service unavailable. Please check your internet connection.';
                            break;
                        default:
                            errorMessage = 'Error: ' + error.code;
                    }
                }
                
                registerFormError.textContent = errorMessage;
                registerFormError.classList.add('show');
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
            }
        };
        
        // Auto-redirect if already logged in
        if (localStorage.getItem('wishboard_user_id')) {
            window.location.href = 'wishboard.html';
        }
    </script>
</body>
</html>