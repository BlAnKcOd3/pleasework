<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>De Anza Marketplace</title>
  <link rel="stylesheet" href="styles.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body data-page="marketplace">
  <header class="header">
    <h1>De Anza Marketplace</h1>
    <div class="icon" id="userIcon" title="Your account"><i class="fas fa-user-circle"></i></div>
  </header>

  <div class="container">
    <div class="action-bar">
      <div class="pill" onclick="location.href='sell.html'">Sell</div>
      <div class="pill" onclick="location.href='listings.html'">Buy</div>

      <div class="search-container" style="margin-left:10px;">
        <input id="search-input" placeholder="Search items..." />
        <i id="search-toggle" class="fas fa-search search-icon" onclick="toggleSearch()"></i>
      </div>
    </div>

    <div class="category-grid">
      <div class="category-item" data-cat="textbooks">
        <div class="icon-box" data-cat="textbooks"><i class="fas fa-book color-gold"></i></div>
        <div class="cat-label">Textbooks</div>
      </div>

      <div class="category-item" data-cat="study-supplies">
        <div class="icon-box" data-cat="study-supplies"><i class="fas fa-pen-fancy color-red"></i></div>
        <div class="cat-label">Study Supplies</div>
      </div>

      <div class="category-item" data-cat="electronics">
        <div class="icon-box" data-cat="electronics"><i class="fas fa-laptop color-red"></i></div>
        <div class="cat-label">Electronics</div>
      </div>

      <div class="category-item" data-cat="bikes">
        <div class="icon-box" data-cat="bikes"><i class="fas fa-bicycle color-red"></i></div>
        <div class="cat-label">Bikes & Outdoors</div>
      </div>

      <div class="category-item" data-cat="housing">
        <div class="icon-box" data-cat="housing"><i class="fas fa-home color-brown"></i></div>
        <div class="cat-label">Housing & Roommates</div>
      </div>

      <div class="category-item" data-cat="services">
        <div class="icon-box" data-cat="services"><i class="fas fa-tools color-red"></i></div>
        <div class="cat-label">Services & Rentals</div>
      </div>

      <div class="category-item" data-cat="jobs">
        <div class="icon-box" data-cat="jobs"><i class="fas fa-briefcase color-brown"></i></div>
        <div class="cat-label">Student Jobs</div>
      </div>

      <div class="category-item" data-cat="events">
        <div class="icon-box" data-cat="events"><i class="fas fa-bell color-gold"></i></div>
        <div class="cat-label">Events & Campus Activities</div>
      </div>

      <!-- Restored Misc/Other Category -->
      <div class="category-item" data-cat="misc">
        <div class="icon-box" data-cat="misc"><i class="fas fa-cubes color-brown"></i></div>
        <div class="cat-label">Other/Misc</div>
      </div>
      
    </div>
  </div>

  <footer class="site-footer">
    <!-- Footer content here if needed -->
    <a href="index.html" class="footer-link">Logout</a>
  </footer>

  <!-- Centralized Firebase config (edit firebase_config.js with your project values) -->
  <script src="firebase_config.js"></script>

  <!-- Chat UI removed: replaced by simple contact flow in listings and required contact fields on sell page -->

  <script type="module">
    // Firebase imports
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, collectionGroup, query, where, getDocs, limit, orderBy, onSnapshot, doc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    
    // Global Firebase instances
    let app, auth, db;
    // Set Firestore log level to debug for better console feedback
    setLogLevel('Debug');

        // --- Firebase Configuration (prefer global `__firebase_config` if present) ---
        let firebaseConfig = {};
        try{
          const parsed = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
          if(parsed && Object.keys(parsed).length) firebaseConfig = parsed;
        }catch(e){ console.warn('Could not parse __firebase_config', e); }
        if(!firebaseConfig || Object.keys(firebaseConfig).length === 0){
          firebaseConfig = {
            apiKey: "AIzaSyBJJYUOM8EBEuT39DX2F_HtxgEbHDRH-Zc",
            authDomain: "deanzahacks11-21-2025.firebaseapp.com",
            projectId: "deanzahacks11-21-2025",
            storageBucket: "deanzahacks11-21-2025.firebasestorage.app",
            messagingSenderId: "253702257130",
            appId: "1:253702257130:web:9ea8e3ee1bd291f1801a93",
            measurementId: "G-5B84R81S31"
          };
        }

    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

    if (!firebaseConfig) {
        console.error("Firebase configuration is missing.");
    } else {
        // Initialize Firebase
        app = initializeApp(firebaseConfig);
        auth = getAuth(app);
        db = getFirestore(app);
        
        // Ensure user is signed in, if not, sign in anonymously
        onAuthStateChanged(auth, (user) => {
                if (!user) {
                  signInAnonymously(auth).catch(e => {
                    console.error("Anonymous Sign-In failed:", e);
                  });
                }
                else {
                  // User is signed in; marketplace does not include chat features anymore.
                  currentUser = user;
                }
        });
    }
    let currentUser = null;

    // --- Search functionality ---
    
    // Handle the category click to navigate to listings with a filter
    document.querySelectorAll('.category-item').forEach(item => {
        item.addEventListener('click', (e) => {
            const category = item.getAttribute('data-cat');
            // Redirect to listings.html with the category as a query parameter
            window.location.href = `listings.html?category=${category}`;
        });
    });

    // Handle search input and icon click
    const searchInput = document.getElementById('search-input');
    const searchIcon = document.getElementById('search-toggle');
    
    window.toggleSearch = function() {
        // The search icon on this page now always triggers a search and redirection
        // to the listings page with the search term.
        const searchTerm = searchInput.value.trim();
        if (searchTerm) {
            window.location.href = `listings.html?search=${encodeURIComponent(searchTerm)}`;
        } else {
            // Optional: just focus if empty, or keep as is. Let's just focus.
            searchInput.focus();
        }
    }

    // Also trigger search on 'Enter' key press
    searchInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            window.toggleSearch();
        }
    });

    // Handle User Icon click for Dashboard/Login
    document.getElementById('userIcon').addEventListener('click', () => {
        onAuthStateChanged(auth, (user) => {
            window.location.href = user && user.email ? 'dashboard.html' : 'login.html';
        }, { once: true });
    });

    // Chat features removed - marketplace now routes to listings/sell and shows contact info from listings

  </script>
</body>
</html>