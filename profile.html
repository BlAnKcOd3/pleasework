<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Profile - De Anza Marketplace</title>
    <link rel="icon" href="https://i.ibb.co/wNYjZG9k/Image-11-21-25-at-2-05-PM.png" type="image/png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Base styles from marketplace.html for consistency */
        body { margin: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #fdfcf5; color: #333; min-height: 100vh; display: flex; flex-direction: column; }
        * { box-sizing: border-box; }
        
        .header { background-color: #4f090c; color: white; padding: 15px 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); position: sticky; top: 0; z-index: 1000; }
        .header-content { max-width: 1200px; margin: 0 auto; display: flex; align-items: center; justify-content: space-between; position: relative; }
        .logo { font-size: 1.5rem; font-weight: 700; color: #f0ce55; cursor: pointer; }
        
        .container { max-width: 800px; margin: 25px auto; padding: 20px; flex-grow: 1; }
        
        /* Profile Card Styling */
        .profile-card {
            background-color: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .profile-icon-large {
            font-size: 4rem;
            color: #4f090c;
            margin-bottom: 15px;
        }

        h2 {
            font-size: 1.8rem;
            color: #4f090c;
            margin-bottom: 5px;
        }

        .student-id {
            color: #777;
            font-size: 0.95rem;
            margin-bottom: 25px;
            padding: 8px 15px;
            background-color: #eee;
            border-radius: 6px;
            display: inline-block;
            font-family: monospace;
        }

        .btn-signout {
            background-color: #f0ce55;
            color: #4f090c;
            border: none;
            padding: 12px 25px;
            border-radius: 25px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s;
        }

        .btn-signout:hover {
            background-color: #ebc034;
            transform: translateY(-1px);
        }

        /* Listings Section */
        .my-listings {
            margin-top: 40px;
            border-top: 1px solid #ddd;
            padding-top: 30px;
        }
        .my-listings h3 {
            color: #4f090c;
            border-bottom: 2px solid #f0ce55;
            padding-bottom: 8px;
            margin-bottom: 20px;
        }
        .listing-item {
            background-color: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .listing-item p { margin: 0; font-weight: 500; }
        .listing-item span { color: #4f090c; font-weight: bold; }
        
        /* Message Box for Status */
        .message-box {
            padding: 15px;
            margin-top: 20px;
            border-radius: 8px;
            text-align: center;
            font-weight: 600;
            display: none; /* Hidden by default */
        }
        .message-box.error {
            background-color: #fdd;
            color: #a00;
            border: 1px solid #f00;
        }
        .message-box.info {
            background-color: #ddf;
            color: #00a;
            border: 1px solid #00f;
        }

        .footer {
            text-align: center;
            padding: 20px;
            margin-top: auto;
            border-top: 1px solid #eee;
            color: #777;
        }
        
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <div class="logo" onclick="window.location.href='marketplace.html'">DA Marketplace</div>
            <a href="marketplace.html" style="color: #f0ce55; font-size: 1.5rem;" title="Marketplace Home">
                <i class="fas fa-home"></i>
            </a>
        </div>
    </header>

    <div class="container">
        <div id="loading-message" class="message-box info" style="display: block;">
            Checking authentication...
        </div>

        <div id="profile-content" style="display: none;">
            <div class="profile-card">
                <i class="fas fa-user-circle profile-icon-large"></i>
                <h2>Welcome Back!</h2>
                <div class="student-id" id="display-student-id">Student ID: [Loading...]</div>
                <button id="signout-button" class="btn-signout">Sign Out</button>
            </div>

            <div class="my-listings">
                <h3>My Current Listings</h3>
                <div id="listings-container">
                    <!-- Listings will be dynamically inserted here -->
                    <div class="listing-item">
                        <p>No active listings found.</p>
                        <a href="sell.html" class="btn-signout" style="padding: 8px 15px; font-size: 0.9rem;">Post New Item</a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <footer class="footer">
        <p>&copy; 2024 De Anza Marketplace. Security enforced by Firebase.</p>
    </footer>

    <script type="module">
        // Import necessary Firebase functions
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        // Firestore is needed for data, but we'll import getFirestore and related methods only if needed
        import { getFirestore, collection, query, where, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global Firebase variables will be defined in setupFirebase
        let auth, db;

        // Mandated Global Variables
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');

        // DOM Elements
        const loadingMessage = document.getElementById('loading-message');
        const profileContent = document.getElementById('profile-content');
        const displayStudentId = document.getElementById('display-student-id');
        const signoutButton = document.getElementById('signout-button');
        const listingsContainer = document.getElementById('listings-container');

        /**
         * Hides or shows a message box element.
         * @param {string} type - 'info' or 'error'.
         * @param {string} message - The message to display.
         * @param {boolean} show - Whether to show (true) or hide (false).
         */
        function displayMessage(type, message, show = true) {
            loadingMessage.classList.remove('info', 'error');
            loadingMessage.textContent = message;
            if (show) {
                loadingMessage.classList.add(type);
                loadingMessage.style.display = 'block';
            } else {
                loadingMessage.style.display = 'none';
            }
        }
        
        /**
         * Loads and displays the user's current listings from Firestore.
         * @param {string} studentId - The authenticated student ID (used as part of the document path).
         * @param {string} userId - The Firebase UID.
         */
        function loadMyListings(studentId, userId) {
            // Firestore data path for private user listings:
            // /artifacts/{appId}/users/{userId}/listings
            const listingsRef = collection(db, `artifacts/${appId}/users/${userId}/listings`);
            
            // Query for listings posted by this student ID (optional filtering, but good practice)
            // Note: Since the listings are stored under the user's private collection,
            // no additional 'where' clause is strictly necessary here, but we can filter by the stored student ID if needed.
            // const q = query(listingsRef, where("studentId", "==", studentId));

            // Use onSnapshot to get real-time updates
            const unsubscribe = onSnapshot(listingsRef, (snapshot) => {
                listingsContainer.innerHTML = ''; // Clear previous listings
                
                if (snapshot.empty) {
                    listingsContainer.innerHTML = `
                        <div class="listing-item">
                            <p>You currently have no active listings.</p>
                            <a href="sell.html" class="btn-signout" style="padding: 8px 15px; font-size: 0.9rem;">Post New Item</a>
                        </div>
                    `;
                    return;
                }

                snapshot.forEach(doc => {
                    const data = doc.data();
                    const listingElement = document.createElement('div');
                    listingElement.className = 'listing-item';
                    
                    const priceDisplay = data.price > 0 ? `$${data.price.toFixed(2)}` : 'FREE';

                    listingElement.innerHTML = `
                        <div>
                            <p>${data.title}</p>
                            <small>${data.category} | <span>${priceDisplay}</span></small>
                        </div>
                        <a href="sell.html?edit=${doc.id}" class="btn-signout" style="padding: 6px 12px; font-size: 0.8rem;">Edit</a>
                    `;
                    listingsContainer.appendChild(listingElement);
                });

            }, (error) => {
                console.error("Error loading user listings:", error);
                listingsContainer.innerHTML = `<div class="message-box error" style="display: block;">Error loading listings.</div>`;
            });
            
            // Return the unsubscribe function in case we need to clean up later
            return unsubscribe;
        }

        /**
         * Initializes Firebase and checks authentication status.
         */
        async function setupProfile() {
            try {
                // Check local storage for the application-level student ID
                const authenticatedStudentId = localStorage.getItem('authenticatedStudentId');

                if (!authenticatedStudentId) {
                    // Critical: Redirect if the application session is missing
                    window.location.href = 'login.html';
                    return; 
                }

                // 1. Initialize Firebase Services
                if (Object.keys(firebaseConfig).length === 0) {
                    console.error("Firebase configuration is missing.");
                    displayMessage('error', 'Configuration error: Firebase not configured.', true);
                    return;
                }
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                
                // 2. We expect to be logged into Firebase from the login/registration process.
                // We will rely on the Firebase Admin SDK to handle the custom token in a real environment.
                // For this front-end implementation, we use the local storage student ID for profile data.

                // Show authenticated content
                displayMessage('info', 'Authenticated successfully.', false); // Hide loading message
                profileContent.style.display = 'block';
                displayStudentId.textContent = `Student ID: ${authenticatedStudentId}`;
                
                // Get the current Firebase user UID for database pathing
                const currentUser = auth.currentUser;
                if (currentUser && currentUser.uid) {
                    // 3. Load user-specific data (Listings)
                    loadMyListings(authenticatedStudentId, currentUser.uid);
                } else {
                    // Fallback if Firebase auth state is lost, but local storage is present
                    console.warn("Firebase user state missing. Re-authenticating needed.");
                    window.location.href = 'login.html';
                }

            } catch (error) {
                console.error("Profile setup failed:", error);
                displayMessage('error', `An error occurred: ${error.message}. Redirecting to login.`, true);
                
                // Fail-safe redirect on any major setup error
                setTimeout(() => {
                    window.location.href = 'login.html';
                }, 3000);
            }
        }

        /**
         * Handles the sign-out process.
         */
        async function handleSignOut() {
            try {
                // 1. Clear the custom application session
                localStorage.removeItem('authenticatedStudentId');
                
                // 2. Sign out the Firebase session
                await signOut(auth);

                // 3. Redirect to the login page
                window.location.href = 'login.html';

            } catch (error) {
                console.error("Sign out failed:", error);
                displayMessage('error', 'Sign out failed. Please try clearing your browser storage.', true);
            }
        }

        // --- Event Listeners ---
        signoutButton.addEventListener('click', handleSignOut);

        // --- Initialization ---
        window.onload = setupProfile;
    </script>
</body>
</html>