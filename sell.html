<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Sell Item - De Anza</title>
  <link rel="stylesheet" href="styles.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body data-page="sell">
  <header class="header"><h1>Sell / Publish</h1></header>

  <div class="container">
    <div id="message-box" class="message-box hidden"></div>

    <div class="form">
      <form id="sell-form">
        <div class="row">
          <div style="flex:1">
            <label class="small">Title</label>
            <input class="input" name="title" placeholder="E.g., Intro Biology textbook" required />
          </div>
          <div style="width:160px">
            <label class="small">Category</label>
            <!-- Restored the 'Other/Misc' option -->
            <select class="input" name="category" required>
              <option value="textbooks">Textbooks</option>
              <option value="study-supplies">Study Supplies</option>
              <option value="electronics">Electronics</option>
              <option value="bikes">Bikes & Outdoors</option>
              <option value="housing">Housing & Roommates</option>
              <option value="services">Services & Rentals</option>
              <option value="jobs">Student Jobs</option>
              <option value="events">Events & Campus Activities</option>
              <option value="misc">Other/Misc</option>
            </select>
          </div>
        </div>

        <label class="small" style="margin-top:12px">Description</label>
        <textarea name="description" placeholder="Add details, condition, pickup info..."></textarea>

        <div class="row" style="margin-top:12px">
          <div style="flex:1">
            <label class="small">Price ($)</label>
            <input class="input" type="number" name="price" step="0.01" placeholder="0 for free or job listing" />
          </div>
          <div style="width:220px">
            <label class="small">Add photos & videos</label>
            <input id="media" class="input" type="file" name="media" accept="image/*,video/*" multiple />
          </div>
        </div>

        <div id="media-preview" class="media-preview"></div>

        <div style="margin-top:14px;display:flex;gap:12px">
          <button class="btn" type="submit">Publish</button>
          <a class="btn" href="listings.html" style="background:#fff;color:#000">View listings</a>
        </div>
      </form>
    </div>
  </div>

  <footer class="site-footer">
    <!-- Footer content here if needed -->
    <a href="index.html" class="footer-link">Logout</a>
  </footer>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    
    // Global Firebase instances
    let app, auth, db, userId = null;
    // Set Firestore log level to debug for better console feedback
    setLogLevel('Debug');

    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

    const messageBox = document.getElementById('message-box');
    const sellForm = document.getElementById('sell-form');

    // --- Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyBJJYUOM8EBEuT39DX2F_HtxgEbHDRH-Zc",
            authDomain: "deanzahacks11-21-2025.firebaseapp.com",
            projectId: "deanzahacks11-21-2025",
            storageBucket: "deanzahacks11-21-2025.firebasestorage.app",
            messagingSenderId: "253702257130",
            appId: "1:253702257130:web:9ea8e3ee1bd291f1801a93",
            measurementId: "G-5B84R81S31"
        };
    // Utility function to display messages
    function displayMessage(type, message) {
        messageBox.className = 'message-box';
        messageBox.textContent = message;
        if (type === 'success') {
            messageBox.classList.add('success');
        } else if (type === 'error') {
            messageBox.classList.add('error');
        }
        messageBox.classList.remove('hidden');
        setTimeout(() => messageBox.classList.add('hidden'), 5000);
    }

    async function setupFirebaseAndListeners() {
        if (!firebaseConfig) {
            console.error("Firebase configuration is missing.");
            displayMessage('error', 'App configuration error. Cannot connect to services.');
            return;
        }

        try {
            // Initialize Firebase
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);

            // Authentication setup
            if (initialAuthToken) {
                await signInWithCustomToken(auth, initialAuthToken);
            } else {
                await signInAnonymously(auth);
            }

            // After sign-in, set the userId
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    userId = user.uid;
                    console.log("User authenticated:", userId);
                    // Enable the form once we have a user ID
                    sellForm.style.pointerEvents = 'auto';
                    sellForm.style.opacity = '1';
                } else {
                    userId = null;
                    console.log("No user authenticated. Form disabled.");
                    displayMessage('error', 'Please log in to publish a listing.');
                    sellForm.style.pointerEvents = 'none';
                    sellForm.style.opacity = '0.5';
                    // Redirect to login if user is not authenticated and not anonymous (i.e. if token existed but failed)
                    if (initialAuthToken) {
                       window.location.href = 'login.html';
                    }
                }
            });

            // Set up form submission listener
            sellForm.addEventListener('submit', handleSellFormSubmit);
            
            // Set up media preview listener
            document.getElementById('media').addEventListener('change', previewMedia);
            
        } catch (error) {
            console.error("Firebase setup failed:", error);
            displayMessage('error', 'Firebase connection error.');
        }
    }

    function previewMedia(event) {
        const previewContainer = document.getElementById('media-preview');
        previewContainer.innerHTML = '';
        const files = event.target.files;

        if (files.length > 0) {
            displayMessage('success', `Added ${files.length} file(s) for preview. Note: Image storage is mocked for this demo.`);
        }
        
        Array.from(files).forEach(file => {
            const fileUrl = URL.createObjectURL(file);
            const mediaElement = document.createElement(file.type.startsWith('video') ? 'video' : 'img');
            mediaElement.src = fileUrl;
            mediaElement.alt = "Preview";
            mediaElement.controls = file.type.startsWith('video');
            mediaElement.style.maxWidth = '100px';
            mediaElement.style.maxHeight = '100px';
            mediaElement.style.marginRight = '10px';
            mediaElement.style.borderRadius = '6px';
            mediaElement.style.objectFit = 'cover';
            
            previewContainer.appendChild(mediaElement);
        });
    }

    async function handleSellFormSubmit(event) {
        event.preventDefault();
        
        if (!userId) {
            displayMessage('error', 'Authentication failed. Please log in.');
            return;
        }

        const formData = new FormData(sellForm);
        const listingData = {
            title: formData.get('title'),
            category: formData.get('category'),
            description: formData.get('description'),
            price: parseFloat(formData.get('price') || 0),
            // Mock image URL since we cannot upload files to cloud storage in this environment
            image: 'https://placehold.co/400x300/4f090c/f0ce55?text=De+Anza+Item',
            userId: userId,
            createdAt: serverTimestamp()
        };

        // Get the public listings collection reference
        const listingsRef = collection(db, `artifacts/${appId}/public/data/listings`);

        displayMessage('success', 'Publishing listing...');
        
        try {
            // Add the new document to the 'listings' collection
            const docRef = await addDoc(listingsRef, listingData);
            console.log("Document written with ID: ", docRef.id);
            
            displayMessage('success', 'Listing successfully published!');
            
            // Clear the form after success
            sellForm.reset();
            document.getElementById('media-preview').innerHTML = '';
            
        } catch (e) {
            console.error("Error adding document: ", e);
            displayMessage('error', 'Failed to publish listing. Please check the console for details.');
        }
    }

    // Initialize Firebase and listeners on window load
    window.onload = setupFirebaseAndListeners;
  </script>
</body>
</html>