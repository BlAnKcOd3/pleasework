<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Sell Item - De Anza Marketplace</title>
  <link rel="icon" href="https://i.ibb.co/wNYjZG9k/Image-11-21-25-at-2-05-PM.png" type="image/png">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <style>
    /* --- Styles for Sell Page (Updated Style Block) --- */
    body {
        background-color: #f8f9fa; /* Light background */
        margin: 0;
        font-family: Arial, Helvetica, sans-serif;
        display: flex;
        flex-direction: column;
        min-height: 100vh;
    }

    header {
        background-color: #6e0b0f; /* De Anza Red */
        padding: 15px 20px;
        display: flex;
        justify-content: center;
        align-items: center;
        height: 80px;
        box-sizing: border-box;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
    }
    header h1 {
        color: white;
        font-size: 1.8em;
        margin: 0;
    }
    
    .container {
        flex-grow: 1;
        max-width: 800px;
        margin: 40px auto;
        padding: 0 20px;
        width: 100%;
    }

    .form {
        background: white;
        padding: 40px;
        border-radius: 20px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
        border: 1px solid #eee;
    }

    .row {
        display: flex;
        gap: 20px;
        margin-bottom: 15px;
    }
    .row > div {
        flex: 1;
    }

    label.small {
        display: block;
        margin-bottom: 6px;
        font-weight: 600;
        color: #444;
        font-size: 0.9em;
    }

    .input, textarea, select {
        width: 100%;
        padding: 12px 15px;
        border: 1px solid #ccc;
        border-radius: 10px;
        font-size: 1em;
        transition: border-color 0.2s;
        box-sizing: border-box;
        background: #f9f9f9;
        outline: none;
    }
    .input:focus, textarea:focus, select:focus {
        border-color: #ebc034; /* Accent color */
        background: white;
    }

    textarea {
        resize: vertical;
        min-height: 120px;
        margin-bottom: 20px;
    }
    
    /* File input styling for consistency */
    input[type="file"] {
        padding: 8px 15px;
    }

    .btn {
        padding: 12px 30px;
        border: none;
        border-radius: 10px;
        font-size: 1em;
        font-weight: 700;
        cursor: pointer;
        transition: all 0.3s ease;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
    }

    .btn[type="submit"] {
        background-color: #6e0b0f; /* De Anza Red */
        color: white;
        box-shadow: 0 4px 15px rgba(110, 11, 15, 0.3);
    }
    .btn[type="submit"]:hover:not(:disabled) {
        background-color: #50080b;
        transform: translateY(-2px);
    }
    .btn[type="submit"]:disabled {
        background-color: #ccc;
        cursor: not-allowed;
    }
    
    /* Cancel button style */
    .btn.cancel { 
        background:#f0f0f0; 
        color:#333; 
        border: 1px solid #ddd;
    }
    .btn.cancel:hover {
        background: #e0e0e0;
    }

    .media-preview {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-top: 15px;
    }
    .media-preview img {
        width: 80px;
        height: 80px;
        object-fit: cover;
        border-radius: 8px;
        border: 1px solid #eee;
    }

    #message-box {
        padding: 15px;
        margin-bottom: 20px;
        border-radius: 10px;
        font-weight: 600;
        border: 1px solid transparent;
        color: #333;
    }
    .info {
        background-color: #e6f7ff;
        border-color: #91d5ff;
        color: #0050b3;
    }
    .success {
        background-color: #f6ffed;
        border-color: #b7eb8f;
        color: #389e0d;
    }
    .error {
        background-color: #fff1f0;
        border-color: #ffa39e;
        color: #cf1322;
    }

    .site-footer {
        text-align: center;
        padding: 20px;
        margin-top: auto;
        border-top: 1px solid #eee;
    }
    .site-footer img {
        height: 30px;
        opacity: 0.6;
    }

    @media (max-width: 600px) {
        .row {
            flex-direction: column;
            gap: 10px;
        }
        .form {
            padding: 20px;
        }
    }
  </style>
</head>
<body data-page="sell">
  <header class="header"><h1>Sell / Publish</h1></header>

  <div class="container">
    <div id="message-box" style="display:none;"></div> 
    <div class="form">
      <form id="sell-form">
        <div class="row">
          <div style="flex:1">
            <label class="small">Title</label>
            <input class="input" name="title" placeholder="E.g., Intro Biology textbook" required />
          </div>
          <div style="width:160px">
            <label class="small">Category</label>
            <select class="input" name="category" required>
              <option value="textbooks">Textbooks</option>
              <option value="study-supplies">Study Supplies</option>
              <option value="electronics">Electronics</option>
              <option value="bikes">Bikes</option>
              <option value="housing">Housing</option>
              <option value="services">Services</option>
              <option value="jobs">Jobs</option>
              <option value="events">Events</option>
              <option value="misc">Other</option>
            </select>
          </div>
        </div>

        <label class="small" style="margin-top:12px">Description</label>
        <textarea name="description" placeholder="Add details, condition, pickup info..." required></textarea>

        <div class="row" style="margin-top:12px">
          <div style="flex:1">
            <label class="small">Price ($)</label>
            <input class="input" type="number" name="price" step="0.01" placeholder="0" required />
          </div>
          <div style="width:220px">
            <label class="small">Add photos</label>
            <input id="media" class="input" type="file" name="media" accept="image/*" />
          </div>
        </div>
        
        <div class="row" style="margin-top:12px">
            <div style="flex:1">
                <label class="small">Contact Email</label>
                <input class="input" type="email" name="contactEmail" placeholder="student@fhda.edu" required />
            </div>
            <div style="flex:1">
                <label class="small">Contact Phone (Optional)</label>
                <input class="input" type="tel" name="contactPhone" placeholder="(555) 555-5555" />
            </div>
        </div>
        <div id="media-preview" class="media-preview"></div>

        <div style="margin-top:14px;display:flex;gap:12px">
          <button id="publish-btn" class="btn" type="submit" disabled>Publish</button>
          <a class="btn cancel" href="listings.html">Cancel</a>
        </div>
      </form>
    </div>
  </div>

  <footer class="site-footer">
    <a href="marketplace.html"><img src="https://i.ibb.co/wNYjZG9k/Image-11-21-25-at-2-05-PM.png" alt="logo"></a>
  </footer>

  <script src="firebase_config.js"></script>

  <script type="module">
    // Firebase imports (v11)
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";
    
    // Global Firebase instances
    let app, auth, db, storage, userId = null;
    let isAuthReady = false;
    setLogLevel('Debug');

    // --- Firebase Configuration (Fallback/Default) ---
    const firebaseConfig = {
        apiKey: "AIzaSyBJJYUOM8EBEuT39DX2F_HtxhEbHDRH-Zc",
        authDomain: "deanzahacks11-21-2025.firebaseapp.com",
        projectId: "deanzahacks11-21-2025",
        storageBucket: "deanzahacks11-21-2025.firebasestorage.app",
        messagingSenderId: "253702257130",
        appId: "1:253702257130:web:9ea8e3ee1bd291f1801a93",
        measurementId: "G-5B84R81S31"
    };

    const appId = 'default-app-id';

    // --- DOM Elements ---
    const sellForm = document.getElementById('sell-form');
    const submitButton = document.getElementById('publish-btn');
    const messageBox = document.getElementById('message-box');
    const mediaInput = document.getElementById('media');
    const mediaPreview = document.getElementById('media-preview');

    // --- Utility Functions ---

    function showMessage(text, type = 'info') {
        messageBox.textContent = text;
        messageBox.className = type;
        messageBox.style.display = 'block';
    }

    async function uploadImage(file) {
        if (!file || !storage) return null;

        const fileExtension = file.name.split('.').pop();
        const fileName = `${userId}_${Date.now()}.${fileExtension}`;
        const storageRef = ref(storage, `listings/${fileName}`);

        try {
            const snapshot = await uploadBytes(storageRef, file);
            const downloadURL = await getDownloadURL(snapshot.ref);
            return downloadURL;
        } catch (error) {
            console.error("Image upload failed:", error);
            showMessage(`Image upload failed: ${error.message}`, 'error');
            return null;
        }
    }

    function handleSellForm(event) {
        event.preventDefault();
        
        if (!userId) {
            showMessage("Error: User not authenticated. Please try reloading the page.", 'error');
            return;
        }

        const formData = new FormData(sellForm);
        const title = formData.get('title').trim();
        const description = formData.get('description').trim();
        const category = formData.get('category');
        const price = parseFloat(formData.get('price'));
        const file = formData.get('media');

        // NEW: Retrieve contact info from the re-added fields
        const contactEmail = formData.get('contactEmail').trim();
        const contactPhone = formData.get('contactPhone').trim();
        // END NEW

        submitButton.disabled = true;
        showMessage("Publishing listing...", 'info');
        
        let imageUrl = '';

        uploadImage(file)
            .then(url => {
                imageUrl = url;
                // Prepare listing data
                const listingData = {
                    userId: userId,
                    title: title,
                    description: description,
                    category: category,
                    price: price,
                    image: imageUrl, 
                    // NEW: Add contact info to listingData object
                    contactEmail: contactEmail,
                    contactPhone: contactPhone,
                    // END NEW
                    createdAt: serverTimestamp()
                };

                // Add document to the specific Firestore path
                const listingsRef = collection(db, `artifacts/${appId}/public/data/listings`);
                return addDoc(listingsRef, listingData);
            })
            .then(() => {
                showMessage("Listing successfully published! Redirecting...", 'success');
                sellForm.reset();
                mediaPreview.innerHTML = '';
                // Redirect after a brief moment
                setTimeout(() => {
                    window.location.href = 'listings.html';
                }, 1500);
            })
            .catch(error => {
                console.error("Error publishing listing:", error);
                showMessage(`Publish failed: ${error.message}`, 'error');
                submitButton.disabled = false;
            });
    }

    function handleMediaChange(event) {
        mediaPreview.innerHTML = '';
        const file = event.target.files[0];
        if (file && file.type.startsWith('image/')) {
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = document.createElement('img');
                img.src = e.target.result;
                img.alt = 'Image Preview';
                mediaPreview.appendChild(img);
            };
            reader.readAsDataURL(file);
        }
    }

    // --- Initialization ---

    function setupFirebase() {
        try {
            // 1. Initialize Firebase
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            storage = getStorage(app); // Initialize Storage

            // 2. Initial anonymous sign-in (if needed)
            onAuthStateChanged(auth, (user) => {
                isAuthReady = true;
                if (user) {
                    userId = user.uid;
                    console.log("User authenticated. UID:", userId);
                    showMessage(`Ready to publish. Authenticated as user ${user.email || user.uid.substring(0, 8)}...`, 'info');
                    submitButton.disabled = false; // Enable form submission
                } else {
                     signInAnonymously(auth).catch(e => {
                        console.error("Anonymous Sign-In failed:", e);
                        showMessage('Authentication failed. Publishing is disabled.', 'error');
                        submitButton.disabled = true;
                    });
                }
            });
            
            // 3. Attach form and media listeners
            sellForm.addEventListener('submit', handleSellForm);
            mediaInput.addEventListener('change', handleMediaChange);

        } catch (error) {
            console.error("FATAL Firebase Initialization Error:", error);
            showMessage(`FATAL Firebase Error: Initialization failed. See console for details.`, 'error');
            submitButton.disabled = true;
        }
    }

    window.onload = setupFirebase;
  </script>
</body>
</html>