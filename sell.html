<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Sell Item - De Anza</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body data-page="sell">
  <header class="header"><h1>Sell / Publish</h1></header>

  <div class="container">
    <div class="form">
      <!-- Success/Error Message Box -->
      <div id="message-box" class="message-box" style="display: none;"></div>
      
      <form id="sell-form">
        <div class="row">
          <div style="flex:1">
            <label class="small">Title</label>
            <input class="input" name="title" placeholder="E.g., Intro Biology textbook" required />
          </div>
          <div style="width:160px">
            <label class="small">Category</label>
            <select class="input" name="category" required>
              <option value="" disabled selected>Select a category</option>
              <option value="textbooks">Textbooks</option>
              <option value="study-supplies">Study Supplies</option>
              <option value="electronics">Electronics</option>
              <option value="bikes">Bikes & Outdoors</option>
              <option value="housing">Housing & Roommates</option>
              <option value="services">Services & Rentals</option>
              <option value="jobs">Student Jobs</option>
              <option value="events">Events & Campus Activities</option>
            </select>
          </div>
        </div>

        <label class="small" style="margin-top:12px">Description</label>
        <textarea name="description" placeholder="Add details, condition, pickup info..."></textarea>

        <div class="row" style="margin-top:12px">
          <div style="flex:1">
            <label class="small">Price ($)</label>
            <input class="input" type="number" name="price" step="0.01" placeholder="0 for free or job listing" />
          </div>
          <div style="width:220px">
            <!-- UPDATED: Input changed from type="file" to type="url" -->
            <label class="small">Image URL (Optional)</label>
            <input id="imageUrlInput" class="input" type="url" name="imageUrl" placeholder="Public image URL (e.g., https://i.imgur.com/photo.jpg)" />
          </div>
        </div>

        <div id="media-preview" class="media-preview"></div>

        <div style="margin-top:14px;display:flex;gap:12px">
          <button class="btn" type="submit">Publish</button>
          <a class="btn" href="listings.html" style="background:#fff;color:#000">View listings</a>
        </div>
      </form>
    </div>
  </div>

  <footer class="site-footer">
    <p>&copy; 2025 De Anza Marketplace</p>
  </footer>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    // REMOVED: Firebase Storage imports are no longer needed.

    // Global variables (provided by Canvas environment)
    const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

    let auth;
    let db;
    let userId = null;

    const sellForm = document.getElementById('sell-form');
    const imageUrlInput = document.getElementById('imageUrlInput'); // UPDATED: Changed variable name
    const mediaPreview = document.getElementById('media-preview');
    const messageBox = document.getElementById('message-box');
    const publishButton = sellForm.querySelector('button[type="submit"]');

    // --- Utility Functions ---

    function displayMessage(type, message) {
        messageBox.textContent = message;
        messageBox.style.display = 'block';
        messageBox.style.backgroundColor = type === 'success' ? '#4CAF50' : '#f44336';
        messageBox.style.color = 'white';
        messageBox.style.padding = '10px';
        messageBox.style.borderRadius = '8px';
        messageBox.style.marginBottom = '20px';
        // Hide after 5 seconds
        setTimeout(() => {
            messageBox.style.display = 'none';
        }, 5000);
    }

    // --- Firebase Setup ---

    function setupFirebase() {
        if (!firebaseConfig) {
            console.error("Firebase configuration is missing. Cannot initialize app.");
            displayMessage('error', 'App configuration error. Cannot publish.');
            return;
        }
        const app = initializeApp(firebaseConfig);
        auth = getAuth(app);
        db = getFirestore(app);

        // Initial sign-in for Canvas environment
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userId = user.uid;
                console.log(`User authenticated. UID: ${userId}`);
            } else {
                // If the user isn't logged in, sign in anonymously
                try {
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        await signInAnonymously(auth);
                    }
                    userId = auth.currentUser.uid;
                } catch (e) {
                    console.error("Authentication failed:", e);
                    displayMessage('error', 'Could not authenticate user. Please refresh.');
                }
            }
        });
    }
    
    // --- Save Logic (Storage removed) ---

    async function handleFormSubmit(event) {
        event.preventDefault();
        
        if (!userId) {
            displayMessage('error', 'Authentication in progress. Please wait a moment and try again.');
            return;
        }

        publishButton.disabled = true;
        publishButton.textContent = 'Publishing...';
        messageBox.style.display = 'none';

        const formData = new FormData(sellForm);
        const title = formData.get('title').trim();
        const description = formData.get('description').trim();
        const category = formData.get('category').trim();
        const price = parseFloat(formData.get('price')) || 0;
        // UPDATED: Get the URL directly from the input
        const imageUrl = formData.get('imageUrl').trim() || null; 

        try {
            // 1. Validation (Optional but recommended for URL)
            if (imageUrl && !imageUrl.startsWith('http')) {
                throw new Error("Image URL must be a valid public link starting with http/https.");
            }

            // 2. Save the listing data to Firestore
            const listingsCollection = collection(db, `artifacts/${appId}/public/data/listings`);

            await addDoc(listingsCollection, {
                title: title,
                description: description,
                category: category,
                price: price,
                imageUrl: imageUrl, // Store the provided URL
                sellerId: userId,
                createdAt: serverTimestamp()
            });

            // 3. Success Feedback
            displayMessage('success', 'Listing published successfully! Redirecting to marketplace...');
            sellForm.reset();
            mediaPreview.innerHTML = ''; // Clear preview
            
            // Redirect after success
            setTimeout(() => {
                window.location.href = 'listings.html';
            }, 1500);

        } catch (error) {
            console.error("Error publishing listing:", error);
            displayMessage('error', `Failed to publish listing: ${error.message}`);
        } finally {
            publishButton.disabled = false;
            publishButton.textContent = 'Publish';
        }
    }
    
    // --- Live URL Preview Logic ---

    function handleUrlChange() {
        mediaPreview.innerHTML = ''; // Clear previous previews
        const url = imageUrlInput.value.trim();
        
        if (url) {
            // Simple validation check before creating the image element
            if (url.startsWith('http') && (url.endsWith('.jpg') || url.endsWith('.png') || url.endsWith('.jpeg') || url.endsWith('.gif'))) {
                const element = document.createElement('img');
                element.src = url;
                element.alt = "Image Preview";
                element.style.maxHeight = '150px';
                element.style.objectFit = 'cover';
                element.style.borderRadius = '8px';
                element.style.marginTop = '10px';
                element.style.maxWidth = '100%';
                
                // Add a basic error handler in case the image doesn't load
                element.onerror = () => {
                    mediaPreview.innerHTML = '<p style="color: red; margin-top: 10px;">Warning: Could not load image from this URL. Check the link.</p>';
                };
                
                mediaPreview.appendChild(element);
            } else {
                 mediaPreview.innerHTML = '<p style="color: #777; margin-top: 10px; font-size:0.9em;">Enter a valid image URL for preview.</p>';
            }
        }
    }

    // --- Initialization & Event Listeners ---
    sellForm.addEventListener('submit', handleFormSubmit);
    // UPDATED: Listen to input changes on the URL field
    imageUrlInput.addEventListener('input', handleUrlChange); 

    window.onload = setupFirebase;
  </script>
</body>
</html>