<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Sell Item - De Anza</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body data-page="sell">
  <header class="header"><h1>Sell / Publish</h1></header>

  <div class="container">
    <div class="form">
      <!-- Success/Error Message Box -->
      <div id="message-box" class="message-box" style="display: none;"></div>
      
      <form id="sell-form">
        <div class="row">
          <div style="flex:1">
            <label class="small">Title</label>
            <input class="input" name="title" placeholder="E.g., Intro Biology textbook" required />
          </div>
          <div style="width:160px">
            <label class="small">Category</label>
            <select class="input" name="category" required>
              <option value="" disabled selected>Select a category</option>
              <option value="textbooks">Textbooks</option>
              <option value="study-supplies">Study Supplies</option>
              <option value="electronics">Electronics</option>
              <option value="bikes">Bikes & Outdoors</option>
              <option value="housing">Housing & Roommates</option>
              <option value="services">Services & Rentals</option>
              <option value="jobs">Student Jobs</option>
              <option value="events">Events & Campus Activities</option>
            </select>
          </div>
        </div>

        <label class="small" style="margin-top:12px">Description</label>
        <textarea name="description" placeholder="Add details, condition, pickup info..."></textarea>

        <div class="row" style="margin-top:12px">
          <div style="flex:1">
            <label class="small">Price ($)</label>
            <input class="input" type="number" name="price" step="0.01" placeholder="0 for free or job listing" />
          </div>
          <div style="width:220px">
            <label class="small">Add photos & videos</label>
            <input id="media" class="input" type="file" name="media" accept="image/*,video/*" multiple />
          </div>
        </div>

        <div id="media-preview" class="media-preview"></div>

        <div style="margin-top:14px;display:flex;gap:12px">
          <button class="btn" type="submit">Publish</button>
          <a class="btn" href="listings.html" style="background:#fff;color:#000">View listings</a>
        </div>
      </form>
    </div>
  </div>

  <footer class="site-footer">
    <p>&copy; 2025 De Anza Marketplace</p>
  </footer>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

    // Global variables (provided by Canvas environment)

    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

    let auth;
    let db;
    let storage;
    let userId = null;

    const sellForm = document.getElementById('sell-form');
    const mediaInput = document.getElementById('media');
    const mediaPreview = document.getElementById('media-preview');
    const messageBox = document.getElementById('message-box');
    const publishButton = sellForm.querySelector('button[type="submit"]');

    // --- Utility Functions ---

    function displayMessage(type, message) {
        messageBox.textContent = message;
        messageBox.style.display = 'block';
        messageBox.style.backgroundColor = type === 'success' ? '#4CAF50' : '#f44336';
        messageBox.style.color = 'white';
        messageBox.style.padding = '10px';
        messageBox.style.borderRadius = '8px';
        messageBox.style.marginBottom = '20px';
        // Hide after 5 seconds
        setTimeout(() => {
            messageBox.style.display = 'none';
        }, 5000);
    }

    // --- Firebase Setup ---
// --- Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyBJJYUOM8EBEuT39DX2F_HtxgEbHDRH-Zc",
            authDomain: "deanzahacks11-21-2025.firebaseapp.com",
            projectId: "deanzahacks11-21-2025",
            storageBucket: "deanzahacks11-21-2025.firebasestorage.app",
            messagingSenderId: "253702257130",
            appId: "1:253702257130:web:9ea8e3ee1bd291f1801a93",
            measurementId: "G-5B84R81S31"
        };
    function setupFirebase() {
        if (!firebaseConfig) {
            console.error("Firebase configuration is missing. Cannot initialize app.");
            displayMessage('error', 'App configuration error. Cannot publish.');
            return;
        }
        const app = initializeApp(firebaseConfig);
        auth = getAuth(app);
        db = getFirestore(app);
        storage = getStorage(app);

        // Initial sign-in for Canvas environment
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userId = user.uid;
                console.log(`User authenticated. UID: ${userId}`);
            } else {
                // If the user isn't logged in (shouldn't happen on a page after marketplace, but as fallback)
                // Sign in anonymously if initial token failed or is absent
                try {
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        await signInAnonymously(auth);
                    }
                    userId = auth.currentUser.uid;
                } catch (e) {
                    console.error("Authentication failed:", e);
                    displayMessage('error', 'Could not authenticate user. Please refresh.');
                }
            }
        });
    }
    
    // --- Upload and Save Logic ---

    async function handleFormSubmit(event) {
        event.preventDefault();
        
        if (!userId) {
            displayMessage('error', 'Authentication in progress. Please wait a moment and try again.');
            return;
        }

        publishButton.disabled = true;
        publishButton.textContent = 'Publishing...';
        messageBox.style.display = 'none';

        const formData = new FormData(sellForm);
        const title = formData.get('title').trim();
        const description = formData.get('description').trim();
        const category = formData.get('category').trim();
        const price = parseFloat(formData.get('price')) || 0;
        const mediaFiles = mediaInput.files;
        let imageUrl = null; // We only store the URL of the first image

        try {
            // 1. Upload the first file (if present) to Storage
            if (mediaFiles.length > 0) {
                const file = mediaFiles[0];
                const storageRef = ref(storage, `listings/${userId}/${Date.now()}_${file.name}`);
                const snapshot = await uploadBytes(storageRef, file);
                imageUrl = await getDownloadURL(snapshot.ref);
                console.log('File uploaded:', imageUrl);
            }

            // 2. Save the listing data to Firestore
            const listingsCollection = collection(db, `artifacts/${appId}/public/data/listings`);

            await addDoc(listingsCollection, {
                title: title,
                description: description,
                category: category,
                price: price,
                imageUrl: imageUrl, // Store the URL
                sellerId: userId,
                createdAt: serverTimestamp()
            });

            // 3. Success Feedback
            displayMessage('success', 'Listing published successfully! Redirecting to marketplace...');
            sellForm.reset();
            mediaPreview.innerHTML = ''; // Clear preview
            
            // Redirect after success
            setTimeout(() => {
                window.location.href = 'listings.html';
            }, 1500);

        } catch (error) {
            console.error("Error publishing listing:", error);
            displayMessage('error', `Failed to publish listing: ${error.message}`);
        } finally {
            publishButton.disabled = false;
            publishButton.textContent = 'Publish';
        }
    }
    
    // --- Media Preview Logic ---

    function handleMediaChange() {
        mediaPreview.innerHTML = ''; // Clear previous previews
        const files = mediaInput.files;
        
        if (files.length > 0) {
            const file = files[0]; // Only show the first file in the simple preview
            const reader = new FileReader();

            reader.onload = (e) => {
                let element;
                if (file.type.startsWith('image/')) {
                    element = document.createElement('img');
                    element.src = e.target.result;
                    element.style.maxHeight = '150px';
                    element.style.objectFit = 'cover';
                } else if (file.type.startsWith('video/')) {
                    element = document.createElement('video');
                    element.src = e.target.result;
                    element.controls = true;
                    element.style.maxHeight = '150px';
                }
                
                if (element) {
                    element.style.borderRadius = '8px';
                    element.style.marginTop = '10px';
                    element.style.maxWidth = '100%';
                    mediaPreview.appendChild(element);
                }
                
                if (files.length > 1) {
                    const count = document.createElement('p');
                    count.textContent = `+ ${files.length - 1} more file(s) attached.`;
                    count.style.fontSize = '0.9em';
                    count.style.color = '#555';
                    mediaPreview.appendChild(count);
                }
            };
            reader.readAsDataURL(file);
        }
    }

    // --- Initialization & Event Listeners ---
    sellForm.addEventListener('submit', handleFormSubmit);
    mediaInput.addEventListener('change', handleMediaChange);

    window.onload = setupFirebase;
  </script>
</body>
</html>