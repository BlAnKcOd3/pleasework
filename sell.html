<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Post a New Listing</title>
    <!-- Load FontAwesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* --- CSS START --- */
        
        /* General Page Reset & Body Styling */
        body {
            margin: 0;
            padding: 0;
            background-color: #f0ce55; /* Gold/Mustard background (Matches De Anza colors) */
            font-family: Arial, Helvetica, sans-serif;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        /* Header Section */
        header {
            background-color: #4f090c; /* Dark Red (Matches De Anza colors) */
            padding: 15px 20px;
            display: flex;
            align-items: center;
            height: 80px;
            box-sizing: border-box;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        h1 {
            color: white;
            font-size: 2.5rem;
            margin: 0 0 0 10px;
            font-weight: bold;
            flex-grow: 1; /* Pushes the back button to the left */
        }
        
        /* Back Button */
        .back-button {
            color: white;
            font-size: 2rem;
            cursor: pointer;
            transition: color 0.2s;
        }
        
        .back-button:hover {
            color: #ffe08a;
        }

        /* Main Content Container */
        .container {
            width: 95%;
            max-width: 700px;
            margin: 30px auto;
            padding: 20px;
            flex: 1;
        }
        
        .form-card {
            background-color: white;
            border: 5px solid #4f090c; /* Dark Red Border */
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
        }
        
        .form-card h2 {
            font-size: 2rem;
            color: #4f090c;
            text-align: center;
            margin-top: 0;
            margin-bottom: 25px;
            padding-bottom: 10px;
            border-bottom: 3px solid #f0ce55;
        }

        /* Form Grouping and Inputs */
        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #4f090c;
            font-size: 1.1rem;
        }

        input[type="text"],
        input[type="number"],
        select,
        textarea {
            width: 100%;
            padding: 10px 15px;
            border: 2px solid #ccc;
            border-radius: 10px;
            box-sizing: border-box;
            font-size: 1rem;
            transition: border-color 0.2s, box-shadow 0.2s;
            outline: none;
        }
        
        input:focus,
        select:focus,
        textarea:focus {
            border-color: #f0ce55;
            box-shadow: 0 0 0 3px rgba(240, 206, 85, 0.5); /* Gold focus ring */
        }

        textarea {
            resize: vertical;
            min-height: 100px;
        }
        
        /* Image Preview Section */
        #imagePreviewContainer {
            margin-top: 15px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100px;
            background-color: #f9f9f9;
        }
        
        #imagePreview {
            max-width: 100%;
            max-height: 200px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        
        .preview-text {
            color: #888;
            font-style: italic;
        }

        /* Submit Button */
        #submitButton {
            width: 100%;
            padding: 15px;
            background-color: #4f090c;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.5rem;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.2s;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        #submitButton:hover:not(:disabled) {
            background-color: #6e0b0f;
            transform: translateY(-2px);
        }
        
        #submitButton:disabled {
            background-color: #aaa;
            cursor: not-allowed;
        }
        
        /* Message Box for Feedback */
        #messageBox {
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            text-align: center;
            font-weight: bold;
            display: none; /* Hidden initially */
            animation: fadeIn 0.5s;
        }

        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* Footer */
        footer {
            background-color: #4f090c;
            height: 40px;
            width: 100%;
            margin-top: auto;
        }
        
        /* Responsive Adjustments */
        @media (max-width: 480px) {
            h1 { font-size: 2rem; }
            .form-card { padding: 15px; }
            .form-card h2 { font-size: 1.5rem; }
            #submitButton { font-size: 1.2rem; padding: 12px; }
        }
        
        /* --- CSS END --- */
    </style>
    
    <!-- Firebase SDK Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";


        // --- Configuration and Initialization ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        if (!firebaseConfig) {
            console.error("Firebase configuration is missing. Cannot initialize app.");
        }
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        const form = document.getElementById('listingForm');
        const messageBox = document.getElementById('messageBox');
        const submitButton = document.getElementById('submitButton');
        const imagePreviewContainer = document.getElementById('imagePreviewContainer');
        const imageInput = document.getElementById('imageUrl');
        let currentUserId = null;


        // Function to display messages (success/error)
        function showMessage(message, type = 'success') {
            messageBox.textContent = message;
            messageBox.className = type === 'success' ? 'success' : 'error';
            messageBox.style.display = 'block';
            
            // Auto-hide after 5 seconds
            setTimeout(() => {
                messageBox.style.display = 'none';
            }, 5000);
        }
        
        // Function to get a fallback placeholder image URL based on title
        function getFallbackPlaceholder(title) {
            const bgColor = '4f090c'; // Dark Red
            const textColor = 'f0ce55'; // Gold
            const text = encodeURIComponent(title.split(' ')[0] || 'Item'); // Use first word of title
            return `https://placehold.co/200x200/${bgColor}/${textColor}?text=${text}`;
        }
        
        // Function to update the image preview based on the URL input
        function updateImagePreview() {
            const url = imageInput.value.trim();
            imagePreviewContainer.innerHTML = ''; // Clear previous content

            if (url) {
                const img = document.createElement('img');
                img.id = 'imagePreview';
                img.src = url;
                
                // Add an error handler for invalid URLs
                img.onerror = function() {
                    this.style.display = 'none';
                    imagePreviewContainer.innerHTML = '<span class="preview-text">Invalid URL or Image Failed to Load. Using placeholder.</span>';
                };
                
                imagePreviewContainer.appendChild(img);
            } else {
                imagePreviewContainer.innerHTML = '<span class="preview-text">Image Preview (Optional)</span>';
            }
        }


        // --- Form Submission Handler ---
        async function handlePostListing(event) {
            event.preventDefault();
            
            if (!currentUserId) {
                showMessage("Authentication error: Please try reloading the page.", 'error');
                return;
            }
            
            submitButton.disabled = true;
            submitButton.textContent = 'Posting...';

            // Get form values
            const title = form.title.value.trim();
            const priceText = form.price.value.trim();
            const category = form.category.value;
            const condition = form.condition.value;
            const description = form.description.value.trim();
            let imageUrl = imageInput.value.trim(); // Get the user-provided URL

            // Simple validation
            if (!title || !priceText || !category || !condition || !description) {
                showMessage("Please fill in all required fields.", 'error');
                submitButton.disabled = false;
                submitButton.textContent = 'Post Listing';
                return;
            }
            
            const price = parseFloat(priceText);
            if (isNaN(price) || price <= 0) {
                showMessage("Please enter a valid price.", 'error');
                submitButton.disabled = false;
                submitButton.textContent = 'Post Listing';
                return;
            }
            
            // If no URL provided, use the fallback placeholder
            if (!imageUrl) {
                imageUrl = getFallbackPlaceholder(title);
            }

            try {
                // Define the public collection path for listings
                const listingsPath = `/artifacts/${appId}/public/data/listings`;
                const listingsCollection = collection(db, listingsPath);
                
                const newListing = {
                    title: title,
                    price: price,
                    category: category,
                    condition: condition,
                    description: description,
                    sellerId: currentUserId,
                    timestamp: new Date().toISOString(),
                    imageUrl: imageUrl // Use the user URL or the fallback
                };

                // Add the new document to Firestore
                await addDoc(listingsCollection, newListing);
                
                showMessage("Success! Your listing has been posted to the marketplace.", 'success');
                
                // Reset the form and preview after successful submission
                form.reset();
                updateImagePreview(); 
                
            } catch (error) {
                console.error("Error adding document: ", error);
                showMessage("An error occurred while posting your listing. Please try again.", 'error');
            } finally {
                submitButton.disabled = false;
                submitButton.textContent = 'Post Listing';
            }
        }


        // --- Authentication and Initialization ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUserId = user.uid;
                console.log('User authenticated. UID:', currentUserId);
            } else {
                currentUserId = null;
                console.warn('User not signed in. Cannot post listings.');
                showMessage("You must be authenticated to post a listing. Attempting anonymous sign-in...", 'error');
            }
        });

        // Initial sign-in for Canvas environment
        if (initialAuthToken) {
            signInWithCustomToken(auth, initialAuthToken).catch(e => {
                console.error("Custom Auth Token Sign-In failed:", e);
                // Fallback to anonymous sign-in if custom token fails
                signInAnonymously(auth).catch(e => {
                    console.error("Anonymous Sign-In failed during fallback:", e);
                });
            });
        } else {
            // Sign in anonymously if no custom token is provided
            signInAnonymously(auth).catch(e => {
                console.error("Anonymous Sign-In failed:", e);
            });
        }
        
        // --- Event Listeners ---
        form.addEventListener('submit', handlePostListing);
        imageInput.addEventListener('input', updateImagePreview);
        
        // Initialize the preview text
        document.addEventListener('DOMContentLoaded', updateImagePreview); 
        
    </script>
</head>
<body>

    <!-- HEADER -->
    <header>
        <!-- Back Button -->
        <i class="fas fa-arrow-left back-button" onclick="window.location.href='homepage.html'"></i>
        <h1>Post an Item</h1>
    </header>

    <div class="container">
        
        <div class="form-card">
            <h2>Your New Listing</h2>
            <form id="listingForm">
                
                <div id="messageBox" class="success"></div>
                
                <!-- Title -->
                <div class="form-group">
                    <label for="title">Item Title (Required)</label>
                    <input type="text" id="title" name="title" placeholder="e.g., CIS 22B Textbook" required maxlength="100">
                </div>

                <!-- Price -->
                <div class="form-group">
                    <label for="price">Price ($USD)</label>
                    <input type="number" id="price" name="price" step="0.01" min="0" placeholder="e.g., 25.00" required>
                </div>

                <!-- Image URL (New Field) -->
                <div class="form-group">
                    <label for="imageUrl">Image URL (Optional)</label>
                    <input type="text" id="imageUrl" name="imageUrl" placeholder="Paste a direct image link here (e.g., from Imgur or Google Photos)">
                    <!-- Image Preview -->
                    <div id="imagePreviewContainer">
                        <span class="preview-text">Image Preview (Optional)</span>
                    </div>
                </div>

                <!-- Category -->
                <div class="form-group">
                    <label for="category">Category</label>
                    <select id="category" name="category" required>
                        <option value="">-- Select Category --</option>
                        <option value="Textbooks">Textbooks</option>
                        <option value="Electronics">Electronics</option>
                        <option value="Furniture">Furniture</option>
                        <option value="Sporting Goods">Sporting Goods</option>
                        <option value="Apparel">Apparel</option>
                        <option value="Services">Services</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                
                <!-- Condition -->
                <div class="form-group">
                    <label for="condition">Condition</label>
                    <select id="condition" name="condition" required>
                        <option value="">-- Select Condition --</option>
                        <option value="New">New</option>
                        <option value="Like New">Like New</option>
                        <option value="Good">Good</option>
                        <option value="Fair">Fair</option>
                        <option value="Poor">Poor</option>
                    </select>
                </div>

                <!-- Description -->
                <div class="form-group">
                    <label for="description">Detailed Description (Required)</label>
                    <textarea id="description" name="description" rows="4" placeholder="Include details like location, usage, and any defects." required maxlength="500"></textarea>
                </div>
                
                <!-- Submit Button -->
                <button type="submit" id="submitButton">Post Listing</button>
            </form>
        </div>
        
    </div>

    <!-- FOOTER -->
    <footer></footer>

</body>
</html>