<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Sell Item - De Anza</title>
  <!-- Load FontAwesome for Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <style>
    /* --- Styles for Sell Page --- */
    body {
        background-color: #f0ce55; /* Gold/Mustard background */
        margin: 0;
        font-family: Arial, Helvetica, sans-serif;
        display: flex;
        flex-direction: column;
        min-height: 100vh;
    }

    header {
        background-color: #4f090c; /* Dark Red */
        padding: 15px 20px;
        display: flex;
        justify-content: center;
        align-items: center;
        height: 80px;
        box-sizing: border-box;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
    }
    header h1 {
        color: white;
        font-size: 1.8em;
        margin: 0;
    }
    
    .container {
        flex-grow: 1;
        padding: 20px;
        max-width: 800px;
        width: 100%;
        margin: 20px auto;
    }
    
    .form {
        background: white;
        padding: 30px;
        border-radius: 12px;
        box-shadow: 0 6px 15px rgba(0, 0, 0, 0.15);
    }
    
    .row {
        display: flex;
        gap: 15px;
        margin-bottom: 15px;
    }
    
    .row > div {
        display: flex;
        flex-direction: column;
    }
    
    .small {
        font-size: 0.9em;
        font-weight: bold;
        color: #4f090c;
        margin-bottom: 5px;
    }
    
    .input, textarea {
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 8px;
        font-size: 1em;
        box-sizing: border-box;
        width: 100%;
        font-family: inherit;
    }
    
    textarea {
        resize: vertical;
        min-height: 100px;
    }
    
    .btn {
        padding: 10px 25px;
        border-radius: 8px;
        font-weight: bold;
        cursor: pointer;
        text-decoration: none;
        text-align: center;
        transition: background-color 0.2s, transform 0.1s;
        border: 2px solid transparent;
        font-size: 1em;
    }
    
    .btn[type="submit"] {
        background-color: #4f090c; /* Dark Red */
        color: white;
        border-color: #4f090c;
        flex-grow: 1;
    }
    
    .btn[type="submit"]:hover:not(:disabled) {
        background-color: #6e0b0f;
    }

    .btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .btn[href] {
        background: #f0ce55; /* Gold */
        color: #4f090c;
        border-color: #4f090c;
        flex-grow: 1;
    }

    /* Message Box Styling */
    #message-box {
        padding: 12px;
        border-radius: 8px;
        margin-bottom: 20px;
        text-align: center;
        font-weight: bold;
        display: none; /* Hidden by default */
    }
    .msg-success {
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }
    .msg-error {
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
    }
    .msg-info {
        background-color: #cce5ff;
        color: #004085;
        border: 1px solid #b8daff;
    }
    
    .site-footer {
        background-color: #4f090c;
        color: white;
        text-align: center;
        padding: 10px 0;
        margin-top: auto;
    }
    
    /* Responsive */
    @media (max-width: 600px) {
        .row {
            flex-direction: column;
            gap: 10px;
        }
        .row > div {
            width: 100%;
        }
    }
  </style>
</head>
<body data-page="sell">
  <header>
    <h1>Sell / Publish</h1>
  </header>

  <div class="container">
    <div id="message-box"></div>
    <div class="form">
      <form id="sell-form">
        <div class="row">
          <div style="flex:1">
            <label class="small">Title</label>
            <input class="input" name="title" placeholder="E.g., Intro Biology textbook" required />
          </div>
          <div style="width:160px">
            <label class="small">Category</label>
            <select class="input" name="category" required>
              <option value="textbooks">Textbooks</option>
              <option value="study-supplies">Study Supplies</option>
              <option value="electronics">Electronics</option>
              <option value="bikes">Bikes & Outdoors</option>
              <option value="housing">Housing & Roommates</option>
              <option value="services">Services & Rentals</option>
              <option value="jobs">Student Jobs</option>
              <option value="events">Events & Campus Activities</option>
              <option value="misc">Other/Misc</option>
            </select>
          </div>
        </div>

        <label class="small" style="margin-top:12px">Description</label>
        <textarea name="description" placeholder="Add details, condition, pickup info..." required></textarea>

        <div class="row" style="margin-top:12px">
          <div style="flex:1">
            <label class="small">Price ($)</label>
            <input class="input" type="number" name="price" step="0.01" placeholder="0 for free or job listing" min="0" required/>
          </div>
          <div style="flex:1">
            <label class="small">Image URL (Optional)</label>
            <input class="input" type="text" name="image" placeholder="URL for an image (e.g., from Placehold.co)" />
          </div>
        </div>

        <div style="margin-top:20px;display:flex;gap:12px">
          <button id="publish-btn" class="btn" type="submit" disabled>Publish Listing</button>
          <a class="btn" href="listings.html">View Listings</a>
        </div>
      </form>
    </div>
  </div>

  <footer class="site-footer">
    De Anza Student Marketplace
  </footer>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, addDoc, collection, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    
    // Set Firestore log level to debug for better console feedback
    setLogLevel('Debug');

    // --- Global Variables ---
    let app, auth, db, userId = null;
    let isAuthReady = false;

    // MANDATORY GLOBAL VARIABLE ACCESS
  const firebaseConfig = {
            apiKey: "AIzaSyBJJYUOM8EBEuT39DX2F_HtxgEbHDRH-Zc",
            authDomain: "deanzahacks11-21-2025.firebaseapp.com",
            projectId: "deanzahacks11-21-2025",
            storageBucket: "deanzahacks11-21-2025.firebasestorage.app",
            messagingSenderId: "253702257130",
            appId: "1:253702257130:web:9ea8e3ee1bd291f1801a93",
            measurementId: "G-5B84R81S31"
        };    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

    // --- DOM Elements ---
    const sellForm = document.getElementById('sell-form');
    const messageBox = document.getElementById('message-box');
    const submitButton = document.getElementById('publish-btn');
    
    // --- Utility Function ---
    function showMessage(text, type) {
        messageBox.textContent = text;
        messageBox.className = '';
        messageBox.classList.add('msg-' + type);
        messageBox.style.display = 'block';
    }

    // --- Core Logic ---
    
    async function handleSellForm(event) {
        event.preventDefault();
        
        if (!isAuthReady || !userId) {
            showMessage('Authentication not ready. Please wait a moment or refresh.', 'error');
            return;
        }

        submitButton.disabled = true;
        showMessage('Publishing listing...', 'info');

        try {
            // 1. Collect form data
            const formData = new FormData(sellForm);
            const listingData = {
                title: formData.get('title').trim(),
                description: formData.get('description').trim(),
                price: parseFloat(formData.get('price')) || 0,
                category: formData.get('category'),
                image: formData.get('image').trim() || null,
                
                // MANDATORY Firestore Fields
                userId: userId,
                createdAt: serverTimestamp()
            };
            
            // 2. Define the public collection path
            const listingsRef = collection(db, `artifacts/${appId}/public/data/listings`);

            // 3. Save the document
            const docRef = await addDoc(listingsRef, listingData);
            
            showMessage(`Success! Listing published with ID: ${docRef.id}`, 'success');
            sellForm.reset(); // Clear the form
            
        } catch (error) {
            console.error("Error publishing listing:", error);
            // Check for specific error codes if available, otherwise show generic error
            showMessage(`Firebase write failed. Check console for details. Error: ${error.message.substring(0, 50)}...`, 'error');
        } finally {
            submitButton.disabled = false;
        }
    }

    async function setupFirebase() {
        if (!firebaseConfig) {
            console.error("Firebase configuration is missing.");
            showMessage('Configuration Error: Cannot load Firebase services.', 'error');
            return;
        }

        try {
            // 1. Initialize Firebase
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);

            // 2. Attempt authentication using the provided token (or anonymously as a fallback)
            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                 console.error("Initial Authentication failed, attempting Anonymous fallback:", error);
                 await signInAnonymously(auth); // Final attempt to get an anonymous user
            }

            // 3. Set up auth state listener
            onAuthStateChanged(auth, (user) => {
                isAuthReady = true;
                if (user) {
                    userId = user.uid;
                    console.log("User authenticated. UID:", userId);
                    showMessage(`Ready to publish. Authenticated as user ${userId.substring(0, 8)}...`, 'info');
                    submitButton.disabled = false; // Enable form submission
                } else {
                    userId = null;
                    console.error("Authentication failed. Cannot get a user ID.");
                    showMessage('Authentication failed. Cannot publish listing.', 'error');
                    submitButton.disabled = true;
                }
            });
            
            // 4. Attach form listener
            sellForm.addEventListener('submit', handleSellForm);

        } catch (error) {
            console.error("Fatal Firebase Initialization Error:", error);
            showMessage('FATAL Firebase connection error. See console.', 'error');
            submitButton.disabled = true;
        }
    }

    window.onload = setupFirebase;
  </script>
</body>
</html>