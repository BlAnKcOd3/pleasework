<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Sell Item - De Anza Marketplace</title>
  <link rel="icon" href="https://i.ibb.co/wNYjZG9k/Image-11-21-25-at-2-05-PM.png" type="image/png">
  <!-- Load Tailwind CSS for utility classes -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <style>
    /* Custom styles for the marketplace theme and structure */
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap');
    
    body {
        background-color: #f8f9fa; /* Light grey background */
        margin: 0;
        font-family: 'Inter', sans-serif;
        display: flex;
        flex-direction: column;
        min-height: 100vh;
    }

    /* Header Styling */
    .header {
        background-color: #6e0b0f; /* De Anza Red */
        padding: 1rem;
        display: flex;
        justify-content: center;
        align-items: center;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        height: 60px;
    }
    .header h1 {
        color: white;
        font-size: 1.5rem;
        font-weight: 700;
        margin: 0;
    }
    
    /* Main Container */
    .container {
        flex-grow: 1;
        max-width: 800px;
        margin: 40px auto;
        padding: 0 1rem;
        width: 100%;
    }

    /* Form Card Styling */
    .form {
        background: white;
        padding: 2rem;
        border-radius: 1rem;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
        border: 1px solid #eee;
    }

    /* Form Rows (Flexbox for responsiveness) */
    .row {
        display: flex;
        gap: 1.5rem; /* 24px */
    }
    .row > div {
        flex: 1;
    }
    
    /* Label and Input Styling */
    label.small {
        display: block;
        margin-bottom: 0.375rem; /* 6px */
        font-weight: 600;
        color: #444;
        font-size: 0.9rem;
    }

    .input, textarea, select {
        width: 100%;
        padding: 0.75rem 1rem; /* 12px 16px */
        border: 1px solid #ccc;
        border-radius: 0.625rem; /* 10px */
        font-size: 1em;
        transition: border-color 0.2s, box-shadow 0.2s;
        box-sizing: border-box;
        background: #f9f9f9;
        outline: none;
    }
    .input:focus, textarea:focus, select:focus {
        border-color: #ebc034; /* De Anza Gold Accent */
        box-shadow: 0 0 0 2px rgba(235, 192, 52, 0.2);
        background: white;
    }

    textarea {
        resize: vertical;
        min-height: 120px;
        margin-bottom: 1.25rem; /* 20px */
    }

    /* Button Styling */
    .btn {
        padding: 0.75rem 1.5rem;
        border: none;
        border-radius: 0.625rem;
        font-size: 1rem;
        font-weight: 700;
        cursor: pointer;
        transition: all 0.3s ease;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
    }

    .btn[type="submit"] {
        background-color: #6e0b0f; /* De Anza Red */
        color: white;
        box-shadow: 0 4px 15px rgba(110, 11, 15, 0.3);
    }
    .btn[type="submit"]:hover:not(:disabled) {
        background-color: #50080b;
        transform: translateY(-2px);
    }
    .btn[type="submit"]:disabled {
        background-color: #d1d5db; /* Tailwind gray-300 */
        color: #6b7280; /* Tailwind gray-500 */
        box-shadow: none;
        cursor: not-allowed;
    }
    
    /* Cancel button style */
    .btn.cancel { 
        background:#f3f4f6; /* Tailwind gray-100 */
        color:#374151; /* Tailwind gray-700 */
        border: 1px solid #e5e7eb; /* Tailwind gray-200 */
    }
    .btn.cancel:hover {
        background: #e5e7eb; /* Tailwind gray-200 */
    }
    
    /* Media Preview */
    .media-preview {
        display: flex;
        flex-wrap: wrap;
        gap: 0.625rem; /* 10px */
        margin-top: 1rem;
    }
    .media-preview img {
        width: 80px;
        height: 80px;
        object-fit: cover;
        border-radius: 0.5rem;
        border: 1px solid #eee;
    }
    
    /* Message Box */
    #message-box {
        padding: 1rem;
        margin-bottom: 1.25rem;
        border-radius: 0.625rem;
        font-weight: 600;
        border: 1px solid transparent;
        color: #333;
    }
    .info { background-color: #e6f7ff; border-color: #91d5ff; color: #0050b3; }
    .success { background-color: #f6ffed; border-color: #b7eb8f; color: #389e0d; }
    .error { background-color: #fff1f0; border-color: #ffa39e; color: #cf1322; }

    /* Footer */
    .site-footer {
        text-align: center;
        padding: 1.25rem;
        margin-top: auto;
        border-top: 1px solid #eee;
    }
    .site-footer img {
        height: 30px;
        opacity: 0.6;
    }

    /* Responsive adjustments */
    @media (max-width: 600px) {
        .row {
            flex-direction: column;
            gap: 0.75rem; /* 12px */
        }
        .form {
            padding: 1rem;
        }
        .row > div {
            width: 100% !important; /* Ensure full width in mobile */
        }
    }
  </style>
</head>
<body data-page="sell">
  <header class="header"><h1>Sell / Publish</h1></header>

  <div class="container">
    <!-- Message Box for feedback -->
    <div id="message-box" style="display:none;"></div> 
    
    <div class="form">
      <form id="sell-form">
        <!-- Title & Category Row -->
        <div class="row">
          <div style="flex:1">
            <label class="small">Title</label>
            <input class="input" name="title" placeholder="E.g., Intro Biology textbook" required />
          </div>
          <div style="width:160px">
            <label class="small">Category</label>
            <select class="input" name="category" required>
              <option value="textbooks">Textbooks</option>
              <option value="study-supplies">Study Supplies</option>
              <option value="electronics">Electronics</option>
              <option value="bikes">Bikes</option>
              <option value="housing">Housing</option>
              <option value="services">Services</option>
              <option value="jobs">Jobs</option>
              <option value="events">Events</option>
              <option value="misc">Other</option>
            </select>
          </div>
        </div>

        <!-- Description -->
        <label class="small" style="margin-top:12px">Description</label>
        <textarea name="description" placeholder="Add details, condition, pickup info..." required></textarea>

        <!-- Price & Photo Row -->
        <div class="row" style="margin-top:12px">
          <div style="flex:1">
            <label class="small">Price ($)</label>
            <input class="input" type="number" name="price" step="0.01" placeholder="0" required />
          </div>
          <div style="width:220px">
            <label class="small">Add photos</label>
            <input id="media" class="input" type="file" name="media" accept="image/*" />
          </div>
        </div>
        
        <!-- Contact Info Row (Added back for completeness) -->
        <div class="row" style="margin-top:12px">
            <div style="flex:1">
                <label class="small">Contact Email</label>
                <input class="input" type="email" name="contactEmail" placeholder="student@fhda.edu" required />
            </div>
            <div style="flex:1">
                <label class="small">Contact Phone (Optional)</label>
                <input class="input" type="tel" name="contactPhone" placeholder="(555) 555-5555" />
            </div>
        </div>
        
        <!-- Media Preview Area -->
        <div id="media-preview" class="media-preview"></div>

        <!-- Action Buttons -->
        <div style="margin-top:14px;display:flex;gap:12px">
          <button id="publish-btn" class="btn" type="submit" disabled>Publish</button>
          <a class="btn cancel" href="listings.html">Cancel</a>
        </div>
      </form>
    </div>
  </div>

  <footer class="site-footer">
    <a href="marketplace.html"><img src="https://i.ibb.co/wNYjZG9k/Image-11-21-25-at-2-05-PM.png" alt="logo"></a>
  </footer>

  <!--
    NOTE: In a real environment, __firebase_config and __app_id would be provided
    by the runtime. Using fallback values for demonstration.
  -->
  <script type="module">
    // Firebase imports (v11)
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";
    
    // Global Firebase instances
    let app, auth, db, storage, userId = null;
    setLogLevel('Debug');

    // --- Firebase Configuration Setup ---
    const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
        apiKey: "AIzaSyBJJYUOM8EBEuT39DX2F_HtxhEbHDRH-Zc",
        authDomain: "deanzahacks11-21-2025.firebaseapp.com",
        projectId: "deanzahacks11-21-2025",
        storageBucket: "deanzahacks11-21-2025.firebasestorage.app",
        messagingSenderId: "253702257130",
        appId: "1:253702257130:web:9ea8e3ee1bd291f1801a93",
        measurementId: "G-5B84R81S31"
    };
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

    // --- DOM Elements ---
    const sellForm = document.getElementById('sell-form');
    const submitButton = document.getElementById('publish-btn');
    const messageBox = document.getElementById('message-box');
    const mediaInput = document.getElementById('media');
    const mediaPreview = document.getElementById('media-preview');

    // --- Utility Functions ---

    function showMessage(text, type = 'info') {
        messageBox.textContent = text;
        messageBox.className = type;
        messageBox.style.display = 'block';
    }

    /**
     * Uploads an image file to Firebase Storage.
     * @param {File} file The image file to upload.
     * @returns {Promise<string|null>} The download URL of the uploaded image, or null on failure.
     */
    async function uploadImage(file) {
        if (!file || !storage || !userId) return null;

        const fileExtension = file.name.split('.').pop();
        // Use a unique path: artifacts/{appId}/listings/{userId}_{timestamp}.{ext}
        const fileName = `${userId}_${Date.now()}.${fileExtension}`;
        const storageRef = ref(storage, `artifacts/${appId}/listings/${fileName}`);

        try {
            const snapshot = await uploadBytes(storageRef, file);
            const downloadURL = await getDownloadURL(snapshot.ref);
            return downloadURL;
        } catch (error) {
            console.error("Image upload failed:", error);
            showMessage(`Image upload failed. Check the file size or format.`, 'error');
            return null;
        }
    }

    /**
     * Handles the form submission to create a new listing.
     * @param {Event} event The submit event.
     */
    function handleSellForm(event) {
        event.preventDefault();
        
        if (!userId || !db) {
            showMessage("Error: Authentication not complete. Please wait a moment or reload.", 'error');
            return;
        }

        const formData = new FormData(sellForm);
        const title = formData.get('title').trim();
        const description = formData.get('description').trim();
        const category = formData.get('category');
        const price = parseFloat(formData.get('price'));
        const file = formData.get('media');

        const contactEmail = formData.get('contactEmail').trim();
        const contactPhone = formData.get('contactPhone').trim();

        submitButton.disabled = true;
        showMessage("Publishing listing, please wait...", 'info');
        
        let imageUrl = '';

        // 1. Upload the image (if one was selected)
        const uploadPromise = file.name ? uploadImage(file) : Promise.resolve('');

        uploadPromise
            .then(url => {
                imageUrl = url;
                // 2. Prepare and save listing data to Firestore
                const listingData = {
                    userId: userId,
                    title: title,
                    description: description,
                    category: category,
                    price: price,
                    image: imageUrl, 
                    contactEmail: contactEmail,
                    contactPhone: contactPhone,
                    createdAt: serverTimestamp()
                };

                // Public collection path: artifacts/{appId}/public/data/listings
                const listingsRef = collection(db, `artifacts/${appId}/public/data/listings`);
                return addDoc(listingsRef, listingData);
            })
            .then(() => {
                showMessage("Listing successfully published! Redirecting to marketplace...", 'success');
                sellForm.reset();
                mediaPreview.innerHTML = '';
                // Redirect after a brief moment to let the user see the success message
                setTimeout(() => {
                    window.location.href = 'listings.html';
                }, 1500);
            })
            .catch(error => {
                console.error("Error publishing listing:", error);
                showMessage(`Publish failed: ${error.message}`, 'error');
                submitButton.disabled = false;
            });
    }

    /**
     * Handles file selection to display a quick image preview.
     * @param {Event} event The change event.
     */
    function handleMediaChange(event) {
        mediaPreview.innerHTML = '';
        const file = event.target.files[0];
        if (file && file.type.startsWith('image/')) {
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = document.createElement('img');
                img.src = e.target.result;
                img.alt = 'Image Preview';
                mediaPreview.appendChild(img);
            };
            reader.readAsDataURL(file);
        }
    }

    // --- Initialization ---

    function setupFirebase() {
        try {
            // 1. Initialize Firebase services
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            storage = getStorage(app); 

            // 2. Authentication setup
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    userId = user.uid;
                    console.log("User authenticated. UID:", userId);
                    showMessage(`Ready to publish. User ID: ${userId.substring(0, 8)}...`, 'info');
                    submitButton.disabled = false; // Enable form submission
                } else {
                     // Sign in anonymously if no user is found
                     signInAnonymously(auth).catch(e => {
                        console.error("Anonymous Sign-In failed:", e);
                        showMessage('Authentication failed. Publishing is disabled.', 'error');
                        submitButton.disabled = true;
                    });
                }
            });
            
            // 3. Attach event listeners
            sellForm.addEventListener('submit', handleSellForm);
            mediaInput.addEventListener('change', handleMediaChange);

        } catch (error) {
            console.error("FATAL Firebase Initialization Error:", error);
            showMessage(`FATAL Firebase Error: Initialization failed. Check console.`, 'error');
            submitButton.disabled = true;
        }
    }

    window.onload = setupFirebase;
  </script>
</body>
</html>