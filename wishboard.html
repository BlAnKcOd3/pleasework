<!DOCTYPE html>
<html lang="en">
<head>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics.js"></script>
    <meta charset="UTF-8">
    <title>De Anza Marketplace</title>
    <style>
        body { font-family: Arial, sans-serif; background: #f7f7f7; margin: 0; padding: 0; }
        .container { max-width: 500px; margin: 40px auto; background: #fff; padding: 24px; border-radius: 8px; box-shadow: 0 2px 8px #ccc; }
        h1 { text-align: center; color: #2d6a4f; }
        .warn { color: #d90429; font-size:1em; font-weight:bold; margin-bottom:12px; text-align:center; }
        .userbar { margin-bottom:12px; text-align:center; }
        .userbar span { color:#2d6a4f; font-weight:bold; }
        .userbar button { margin-left:8px; background:#ffd166; color:#2d6a4f; border:none; border-radius:4px; padding:4px 10px; cursor:pointer; font-size:0.95em; }
        .actions { margin-bottom:12px; text-align:center; }
        .actions button { background:#e63946; color:#fff; border:none; border-radius:4px; padding:4px 12px; cursor:pointer; font-size:0.95em; margin-right:8px; }
        .actions .delete { background:#6c757d; }
        form { display: flex; flex-direction: column; gap: 8px; margin-bottom: 18px; }
        form > input[type="text"], form > input[type="number"], form > select, form > textarea { width: 100%; padding: 8px; border-radius: 4px; border: 1px solid #ccc; box-sizing: border-box; }
        form > input[type="number"] { max-width: 150px; }
        button[type="submit"] { background: #2d6a4f; color: #fff; border: none; border-radius: 4px; padding: 8px 16px; cursor: pointer; }
        button[type="submit"]:hover { background: #40916c; }
        .filters { margin-bottom: 16px; text-align: center; }
        .filters button { background: #b7e4c7; color: #2d6a4f; margin: 0 4px; }
        ul { list-style: none; padding: 0; }
        li { background: #e9ecef; margin-bottom: 12px; padding: 12px; border-radius: 6px; display: flex; flex-direction: column; align-items: flex-start; }
        .listing-header { font-size: 1.1em; font-weight: bold; color: #2d6a4f; margin-bottom: 4px; }
        .listing-details { margin-bottom: 6px; }
        .tag { background: #ffd166; color: #6c757d; border-radius: 4px; padding: 2px 8px; margin-left: 8px; font-size: 0.9em; }
        .category { background: #b7e4c7; color: #2d6a4f; border-radius: 4px; padding: 2px 8px; margin-left: 8px; font-size: 0.9em; }
        .contact { background: #06d6a0; color: #fff; border-radius: 4px; padding: 2px 8px; margin-left: 8px; font-size: 0.9em; }
        .image-upload { margin: 8px 0; }
        .image-upload input[type="file"] { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
        .image-preview-container { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 8px; }
        .image-preview { position: relative; width: 80px; height: 80px; border: 1px solid #ccc; border-radius: 4px; overflow: hidden; }
        .image-preview img { width: 100%; height: 100%; object-fit: cover; }
        .image-preview .remove-image { position: absolute; top: 2px; right: 2px; background: rgba(217, 4, 41, 0.8); color: white; border: none; border-radius: 50%; width: 20px; height: 20px; cursor: pointer; font-size: 12px; line-height: 1; }
        .negotiable-option { display: flex; align-items: center; gap: 8px; margin: 8px 0; }
        .negotiable-option input[type="checkbox"] { width: 18px; height: 18px; cursor: pointer; }
        .negotiable-option label { cursor: pointer; color: #2d6a4f; font-weight: bold; }
        .negotiable-badge { background: #ffd166; color: #2d6a4f; border-radius: 4px; padding: 2px 8px; margin-left: 8px; font-size: 0.9em; font-weight: bold; }
        .listing-images { display: flex; flex-wrap: wrap; gap: 8px; margin: 8px 0; }
        .listing-images img { max-width: 150px; max-height: 150px; border-radius: 4px; object-fit: cover; cursor: pointer; }
        textarea { width: 100%; padding: 8px; border-radius: 4px; border: 1px solid #ccc; font-family: Arial, sans-serif; resize: vertical; min-height: 60px; }
        .edit-btn { background: #40916c; color: #fff; border: none; border-radius: 4px; padding: 4px 10px; cursor: pointer; font-size: 0.9em; margin-left: 8px; }
        .edit-btn:hover { background: #2d6a4f; }
        .currency-symbol { font-weight: bold; color: #2d6a4f; }
        input[type="range"] { width: 100%; height: 8px; border-radius: 4px; background: #e0e0e0; outline: none; }
        input[type="range"]::-webkit-slider-thumb { appearance: none; width: 20px; height: 20px; border-radius: 50%; background: #2d6a4f; cursor: pointer; }
        input[type="range"]::-moz-range-thumb { width: 20px; height: 20px; border-radius: 50%; background: #2d6a4f; cursor: pointer; border: none; }
    </style>
</head>
<body>
    <nav style="width:100%;display:flex;justify-content:center;align-items:center;padding:16px 0 0 0;box-sizing:border-box;margin-bottom:16px;">
        <a href="index.html">Firestore Demo</a> |
        <a href="login.html">Login</a> |
        <a href="testfile.html">Home</a>
    </nav>
    <div class="topbar" style="width:100%;display:flex;justify-content:flex-end;align-items:center;padding:16px 32px 0 0;box-sizing:border-box;">
        <button id="loginBtn" style="background:#2d6a4f;color:#fff;border:none;border-radius:4px;padding:8px 20px;cursor:pointer;font-size:1em;">Login</button>
    </div>
    <div class="container">
        <h1>De Anza Marketplace</h1>
        <div class="actions">
            <button id="logoutBtn">Log Out</button>
            <button id="deleteDataBtn" class="delete">Delete All Data</button>
        </div>
        <div class="userbar">
            <span id="currentUser"></span>
            <button id="changeUserBtn">Change Name</button>
        </div>
        <form id="postForm">
            <input type="text" id="title" placeholder="Item Title" required maxlength="40">
            <!-- Password Section Start -->
            <input type="password" id="password" placeholder="Enter password" maxlength="40" style="margin-bottom:8px;">
            <input type="password" id="confirmPassword" placeholder="Confirm password" maxlength="40" style="margin-bottom:8px;">
            <div id="reenterPasswordSection" style="display:none; flex-direction:column; gap:8px;">
                <input type="password" id="reenterPassword" placeholder="Re-enter password" maxlength="40" style="margin-bottom:8px;">
            </div>
            <!-- Password Section End -->
            <div style="display: flex; gap: 8px; align-items: center; margin-bottom:8px;">
                <span style="color: #2d6a4f; font-weight: bold; font-size:1.1em; user-select:none;">$</span>
                <div style="flex:1; position:relative;">
                    <input type="text" id="price" style="width:100%; text-align: right; background: #f7f7f7; position:relative; z-index:2; color:transparent; caret-color:#2d6a4f;" autocomplete="off" maxlength="5">
                    <span id="pricePlaceholder" style="position:absolute; left:8px; top:50%; transform:translateY(-50%); color:#888; font-size:1em; pointer-events:none; z-index:1; font-family:inherit;">0.00</span>
                    <span id="priceOverlay" style="position:absolute; left:8px; top:50%; transform:translateY(-50%); color:#2d6a4f; font-size:1em; pointer-events:none; z-index:3; font-family:inherit;"></span>
                </div>
            <!--// Depop-style price input with left-aligned disappearing placeholder
            const priceInput = document.getElementById('price');
            const pricePlaceholder = document.getElementById('pricePlaceholder');
            const priceOverlay = document.getElementById('priceOverlay');
            if (priceInput && pricePlaceholder && priceOverlay) {
                let priceValue = '';
                function updatePriceDisplay() {
                    // Format as cents
                    let num = priceValue ? parseInt(priceValue, 10) : 0;
                    let formatted = (num / 100).toFixed(2);
                    // Overlay entered digits on top of placeholder
                    let entered = formatted;
                    let placeholder = '0.00';
                    let result = '';
                    let enteredArr = entered.split('');
                    let placeholderArr = placeholder.split('');
                    // Hide placeholder digits from right as user types
                    let hideCount = priceValue.length;
                    for (let i = 0; i < placeholderArr.length; i++) {
                        if (i >= placeholderArr.length - hideCount) {
                            result += '<span style="color:transparent;">' + placeholderArr[i] + '</span>';
                        } else {
                            result += placeholderArr[i];
                        }
                    }
                    pricePlaceholder.innerHTML = result;
                    priceOverlay.textContent = entered;
                    priceInput.value = entered;
                                // Ensure input field never contains HTML
                                if (priceInput.value.includes('<')) {
                                    priceInput.value = entered.replace(/<[^>]*>/g, '');
                                }
                }
                priceInput.addEventListener('keydown', function(e) {
                    // Allow navigation keys
                    if (["ArrowLeft","ArrowRight","Tab"].includes(e.key)) return;
                    // Prevent default for all but numbers and backspace
                    if (!/^[0-9]$/.test(e.key) && e.key !== 'Backspace') {
                        e.preventDefault();
                        return;
                    }
                    e.preventDefault();
                    if (/^[0-9]$/.test(e.key)) {
                        // Add digit to left
                        if (priceValue.length < 5) priceValue = priceValue + e.key;
                    } else if (e.key === 'Backspace') {
                        // Remove last digit
                        priceValue = priceValue.slice(0, -1);
                    }
                    updatePriceDisplay();
                });
                priceInput.addEventListener('focus', function() {
                    priceInput.select();
                });
                priceInput.addEventListener('blur', function() {
                    if (!priceValue) priceValue = '';
                    updatePriceDisplay();
                });
                updatePriceDisplay();
            }!-->
            </div>
            <div class="negotiable-option">
                <input type="checkbox" id="negotiable" name="negotiable">
                <label for="negotiable">Price is negotiable / Open to offers</label>
            </div>
            <select id="category" required>
                <option value="">Please choose one of the categories below</option>
                <option value="Books">Books</option>
                <option value="Electronics">Electronics</option>
                <option value="Furniture">Furniture</option>
                <option value="Services">Services</option>
                <option value="Other">Other</option>
            </select>
            <textarea id="desc" placeholder="Description" required maxlength="500"></textarea>
            <div class="image-upload">
                <input type="file" id="images" accept="image/*" multiple>
                <div class="image-preview-container" id="imagePreview"></div>
            </div>
            <input type="text" id="contact" placeholder="Contact Info" required maxlength="40">
            <input type="hidden" id="editListingId" value="">
            <button type="submit" id="submitBtn">Post Item</button>
        </form>
        <div class="filters">
            <button onclick="filterPosts('All')">All</button>
            <button onclick="filterPosts('Books')">Books</button>
            <button onclick="filterPosts('Electronics')">Electronics</button>
            <button onclick="filterPosts('Furniture')">Furniture</button>
            <button onclick="filterPosts('Services')">Services</button>
            <button onclick="filterPosts('Other')">Other</button>
        </div>
        <button id="refreshListingsBtn" style="background:#6c757d;color:#fff;border:none;border-radius:4px;padding:8px 20px;cursor:pointer;font-size:1em;margin-bottom:16px;width:100%;">Refresh Listings</button>
        <ul id="board"></ul>
    </div>
    <script type="module" src="app.js"></script>
    <script type="module">
// Password re-entry logic
const confirmPasswordInput = document.getElementById('confirmPassword');
const reenterSection = document.getElementById('reenterPasswordSection');
let reenterShown = false;
if (confirmPasswordInput && reenterSection) {
    function showReenter() {
        if (!reenterShown) {
            reenterSection.style.display = 'flex';
            document.getElementById('reenterPassword').focus();
            reenterShown = true;
        }
    }
    confirmPasswordInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            showReenter();
        }
    });
    confirmPasswordInput.addEventListener('blur', function() {
        if (confirmPasswordInput.value) {
            showReenter();
        }
    });
}
// Login button always visible, redirects to login page
document.getElementById('loginBtn').onclick = function() {
    window.location.href = 'login.html';
};

// Image preview handling
let selectedImages = [];
const imageInput = document.getElementById('images');
const imagePreview = document.getElementById('imagePreview');

if (imageInput && imagePreview) {
    imageInput.addEventListener('change', function(e) {
        const files = Array.from(e.target.files);
        
        // Limit to 5 images
        if (selectedImages.length + files.length > 5) {
            alert('Maximum 5 images allowed');
            return;
        }
        
        files.forEach(file => {
            if (file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const imageData = e.target.result;
                    selectedImages.push({ file: file, data: imageData });
                    updateImagePreview();
                };
                reader.readAsDataURL(file);
            }
        });
    });
}

function updateImagePreview() {
    if (!imagePreview) return;
    imagePreview.innerHTML = '';
    selectedImages.forEach((img, index) => {
        const div = document.createElement('div');
        div.className = 'image-preview';
        div.innerHTML = `
            <img src="${img.data}" alt="Preview">
            <button type="button" class="remove-image" onclick="removeImage(${index})">×</button>
        `;
        imagePreview.appendChild(div);
    });
}

window.removeImage = function(index) {
    selectedImages.splice(index, 1);
    updateImagePreview();
    // Update file input
    const dt = new DataTransfer();
    selectedImages.forEach(img => {
        dt.items.add(img.file);
    });
    if (imageInput) {
        imageInput.files = dt.files;
    }
};

// ...removed price slider logic...

import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs, onSnapshot, query, orderBy, where, deleteDoc, doc, updateDoc, getDoc } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCO-w3HsDbLVbEk_J7qYEMkrpgUC_CWn54",
  authDomain: "de-anza-marketplace.firebaseapp.com",
  projectId: "de-anza-marketplace",
  storageBucket: "de-anza-marketplace.firebasestorage.app",
  messagingSenderId: "789429114794",
  appId: "1:789429114794:web:f5240be7a6458f50c07dd3",
  measurementId: "G-Z5NSE0RX1N"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const listingsRef = collection(db, "listings");

function escapeHTML(str) {
    return String(str).replace(/[&<>'"`=]/g, function(s) {
        return ({'&':'&amp;','<':'&lt;','>':'&gt;','\'':'&#39;','"':'&quot;','`':'&#96;','=':'&#61;'}[s]);
    });
}
function showLogin() {
    if (!window.location.pathname.endsWith('login.html')) {
        window.location.href = 'login.html';
    }
}
function updateCurrentUser() {
    const user = localStorage.getItem('wishboard_user') || '(unknown)';
    document.getElementById('currentUser').textContent = 'User: ' + user;
}
document.getElementById('changeUserBtn').onclick = function() {
    // Show a prompt to change the user's name
    const currentName = localStorage.getItem('wishboard_user') || '';
    const newName = prompt('Enter your new name:', currentName);
    if (newName && newName.trim() && newName !== currentName) {
        localStorage.setItem('wishboard_user', newName.trim());
        updateCurrentUser();
    }
};
document.getElementById('logoutBtn').onclick = function() {
    localStorage.removeItem('wishboard_user');
    localStorage.removeItem('wishboard_user_id');
    localStorage.removeItem('wishboard_id_number');
    localStorage.removeItem('wishboard_email');
    localStorage.removeItem('wishboard_device_id');
    // Show login button again
    const loginBtn = document.getElementById('loginBtn');
    if (loginBtn) loginBtn.style.display = 'block';
    showLogin();
};
document.getElementById('deleteDataBtn').onclick = function() {
    if (confirm('Are you sure you want to delete ALL marketplace listings for your current login? This cannot be undone.')) {
        const deleteBtn = document.getElementById('deleteDataBtn');
        deleteBtn.disabled = true;
        deleteBtn.textContent = 'Deleting...';
        (async () => {
            const user = localStorage.getItem('wishboard_user') || '(unknown)';
            const q = query(listingsRef, where('user', '==', user));
            const snapshot = await getDocs(q);
            for (const docSnap of snapshot.docs) {
                await deleteDoc(docSnap.ref);
            }
            localStorage.removeItem('wishboard_user');
            localStorage.removeItem('wishboard_user_id');
            localStorage.removeItem('wishboard_id_number');
            localStorage.removeItem('wishboard_email');
            localStorage.removeItem('wishboard_device_id');
            showLogin();
        })().finally(() => {
            deleteBtn.disabled = false;
            deleteBtn.textContent = 'Delete All Data';
        });
    }
};
let currentFilter = 'All';
// Currency symbols mapping
const currencySymbols = {
    'USD': '$', 'EUR': '€', 'GBP': '£', 'JPY': '¥', 'CNY': '¥', 'INR': '₹', 'AUD': 'A$', 'CAD': 'C$',
    'CHF': 'Fr', 'HKD': 'HK$', 'SGD': 'S$', 'NZD': 'NZ$', 'KRW': '₩', 'MXN': '$', 'BRL': 'R$',
    'ZAR': 'R', 'RUB': '₽', 'TRY': '₺', 'SEK': 'kr', 'NOK': 'kr', 'DKK': 'kr', 'PLN': 'zł',
    'THB': '฿', 'IDR': 'Rp', 'MYR': 'RM', 'PHP': '₱', 'VND': '₫', 'AED': 'د.إ', 'SAR': '﷼',
    'ILS': '₪', 'EGP': 'E£', 'NGN': '₦', 'ARS': '$', 'CLP': '$', 'COP': '$', 'PEN': 'S/',
    'CZK': 'Kč', 'HUF': 'Ft', 'RON': 'lei', 'BGN': 'лв', 'HRK': 'kn', 'UAH': '₴', 'PKR': '₨',
    'BDT': '৳', 'LKR': '₨', 'NPR': '₨', 'MMK': 'K', 'KZT': '₸', 'UZS': 'лв', 'KWD': 'د.ك',
    'QAR': '﷼', 'OMR': '﷼', 'BHD': '.د.ب', 'JOD': 'د.ا', 'LBP': 'ل.ل', 'ISK': 'kr', 'RSD': 'Дин.',
    'BAM': 'КМ', 'MKD': 'ден', 'ALL': 'L', 'MDL': 'L', 'GEL': '₾', 'AMD': '֏', 'AZN': '₼',
    'BYN': 'Br', 'TJS': 'ЅМ', 'TMT': 'm', 'UYU': '$U', 'PYG': 'Gs', 'BOB': 'Bs.', 'GTQ': 'Q',
    'HNL': 'L', 'NIO': 'C$', 'CRC': '₡', 'PAB': 'B/.', 'DOP': 'RD$', 'JMD': 'J$', 'BBD': 'Bds$',
    'BZD': 'BZ$', 'BMD': 'BD$', 'BSD': 'B$', 'XCD': '$', 'AWG': 'ƒ', 'ANG': 'ƒ', 'TTD': 'TT$',
    'GYD': 'G$', 'SRD': '$', 'FJD': 'FJ$', 'PGK': 'K', 'SBD': 'SI$', 'VUV': 'Vt', 'WST': 'WS$',
    'TOP': 'T$', 'XPF': '₣', 'MOP': 'P', 'TWD': 'NT$', 'KHR': '៛', 'LAK': '₭', 'BND': 'B$',
    'AFN': '؋', 'IRR': '﷼', 'IQD': 'ع.د', 'YER': '﷼', 'SYP': '£', 'ETB': 'Br', 'KES': 'KSh',
    'UGX': 'USh', 'TZS': 'TSh', 'RWF': 'RF', 'BIF': 'FBu', 'DJF': 'Fdj', 'SOS': 'S', 'ERN': 'Nfk',
    'SDG': 'ج.س', 'SSP': '£', 'MZN': 'MT', 'AOA': 'Kz', 'ZMW': 'ZK', 'MWK': 'MK', 'MGA': 'Ar',
    'MUR': '₨', 'SCR': '₨', 'KMF': 'CF', 'CDF': 'FC', 'XAF': 'FCFA', 'XOF': 'CFA', 'GHS': '₵',
    'GMD': 'D', 'GNF': 'FG', 'SLL': 'Le', 'LRD': 'L$', 'CVE': '$', 'STN': 'Db', 'GIP': '£',
    'FKP': '£', 'SHP': '£', 'IMP': '£', 'JEP': '£', 'GGP': '£', 'BWP': 'P', 'SZL': 'L',
    'LSL': 'L', 'NAD': 'N$', 'MAD': 'د.م.', 'DZD': 'د.ج', 'TND': 'د.ت', 'LYD': 'ل.د',
    'XDR': 'SDR', 'BTC': '₿', 'ETH': 'Ξ'
};

function renderBoard(posts) {
    const board = document.getElementById('board');
    board.innerHTML = '';
    let filtered = posts;
    if (currentFilter !== 'All') filtered = posts.filter(p => p.category === currentFilter);
    const currentUser = localStorage.getItem('wishboard_user') || '(unknown)';
    
    filtered.forEach((post, idx) => {
        const safeUser = escapeHTML(post.user ? post.user : '(unknown)');
        const safeTitle = escapeHTML(post.title || 'Untitled');
        const safeDesc = escapeHTML(post.desc || '');
        const safeCategory = escapeHTML(post.category || 'Other');
        // Only show formatted price, never overlay HTML
        let displayPrice = post.price;
        if (typeof displayPrice === 'string') {
            displayPrice = displayPrice.replace(/[^0-9.]/g, '');
            if (displayPrice === '') displayPrice = '0.00';
            else displayPrice = parseFloat(displayPrice).toFixed(2);
        }
        const safePrice = displayPrice !== undefined && displayPrice !== '' 
            ? `$${escapeHTML(displayPrice)}` 
            : 'N/A';
        const safeContact = escapeHTML(post.contact || '');
        const negotiable = post.negotiable || false;
        const images = post.images || [];
        const isOwner = safeUser === currentUser;
        
        const li = document.createElement('li');
        li.innerHTML = `
            <div class="listing-header">${safeTitle} <span class="category">${safeCategory}</span></div>
            ${images.length > 0 ? `<div class="listing-images">${images.map(img => `<img src="${img}" alt="${safeTitle}" onclick="window.open('${img}', '_blank')">`).join('')}</div>` : ''}
            <div class="listing-details">${safeDesc}</div>
            <div><strong>Price:</strong> ${safePrice}${negotiable ? '<span class="negotiable-badge">Negotiable</span>' : ''}</div>
            <div><strong>Seller:</strong> ${safeUser}</div>
        `;
        
        if (safeContact) {
            const btn = document.createElement('button');
            btn.className = 'contact';
            btn.textContent = 'Contact Seller';
            btn.addEventListener('click', function() {
                alert('Contact Info: ' + safeContact);
            });
            li.appendChild(btn);
        }
        
        // Add edit button for owner
        if (isOwner && post.id) {
            const editBtn = document.createElement('button');
            editBtn.className = 'edit-btn';
            editBtn.textContent = 'Edit Listing';
            editBtn.addEventListener('click', function() {
                editListing(post.id);
            });
            li.appendChild(editBtn);
        }
        
        board.appendChild(li);
    });
}

async function editListing(listingId) {
    try {
        const docRef = doc(db, "listings", listingId);
        const docSnap = await getDoc(docRef);
        
        if (docSnap.exists()) {
            const data = docSnap.data();
            
            // Populate form
            document.getElementById('title').value = data.title || '';
            const priceValue = parseFloat(data.price) || 0;
            document.getElementById('price').value = priceValue.toFixed(2);
            if (priceSlider) {
                priceSlider.value = priceValue;
                priceDisplay.textContent = '$' + priceValue.toFixed(2);
            }
            document.getElementById('category').value = data.category || '';
            document.getElementById('desc').value = data.desc || '';
            document.getElementById('contact').value = data.contact || '';
            document.getElementById('negotiable').checked = data.negotiable || false;
            document.getElementById('editListingId').value = listingId;
            
            // Handle images
            selectedImages = [];
            if (data.images && data.images.length > 0) {
                data.images.forEach(imgData => {
                    selectedImages.push({ file: null, data: imgData });
                });
            }
            updateImagePreview();
            
            // Change button text
            document.getElementById('submitBtn').textContent = 'Update Listing';
            
            // Scroll to form
            document.getElementById('postForm').scrollIntoView({ behavior: 'smooth' });
        }
    } catch (error) {
        console.error('Error loading listing:', error);
        alert('Error loading listing. Please try again.');
    }
}
// Listen for Firestore changes
const q = query(listingsRef, orderBy("created", "desc"));
onSnapshot(q, (snapshot) => {
    const posts = [];
    snapshot.forEach(docSnap => {
        posts.push({ ...docSnap.data(), id: docSnap.id });
    });
    renderBoard(posts);
});
document.getElementById('postForm').onsubmit = async function(e) {
    e.preventDefault();
    const title = document.getElementById('title').value.trim();
    // Only save formatted price value
    let priceRaw = document.getElementById('price').value.trim();
    let price = priceRaw.replace(/[^0-9.]/g, '');
    if (price === '') price = '0.00';
    else price = parseFloat(price).toFixed(2);
    const category = document.getElementById('category').value;
    const desc = document.getElementById('desc').value.trim();
    const contact = document.getElementById('contact').value.trim();
    const negotiable = document.getElementById('negotiable').checked;
    const editListingId = document.getElementById('editListingId').value;
    
    if (!title || !desc || !contact) {
        alert('Please fill in all required fields (Title, Description, and Contact Info)');
        return;
    }
    
    // Validate category is selected
    if (!category || category === '') {
        alert('Please choose one of the categories below');
        return;
    }
    
    // Validate price format
    if (price && !/^[0-9]+(\.[0-9]{1,2})?$/.test(price)) {
        alert('Please enter a valid price (e.g., 100 or 99.99)');
        return;
    }
    
    // Convert images to base64 array
    const images = selectedImages.map(img => img.data);
    
    const user = localStorage.getItem('wishboard_user') || '(unknown)';
    const listingData = {
        title, price, currency: 'USD', category, desc, contact, user, negotiable, images,
        created: Date.now()
    };
    
    if (editListingId) {
        // Update existing listing
        const docRef = doc(db, "listings", editListingId);
        await updateDoc(docRef, listingData);
    } else {
        // Create new listing
        await addDoc(listingsRef, listingData);
    }
    
    // Reset form
    document.getElementById('title').value = '';
    document.getElementById('price').value = '';
    if (priceSlider) {
        priceSlider.value = 0;
        priceDisplay.textContent = '$0.00';
    }
    document.getElementById('category').value = '';
    document.getElementById('desc').value = '';
    document.getElementById('contact').value = '';
    document.getElementById('negotiable').checked = false;
    document.getElementById('editListingId').value = '';
    document.getElementById('submitBtn').textContent = 'Post Item';
    selectedImages = [];
    if (imagePreview) imagePreview.innerHTML = '';
    if (imageInput) imageInput.value = '';
};
window.filterPosts = function(type) {
    currentFilter = type;
    // Board will auto-update via Firestore listener
};
// Refresh Listings button logic
const refreshBtn = document.getElementById('refreshListingsBtn');
if (refreshBtn) {
    refreshBtn.onclick = async function() {
        await refreshListings();
    };
}

async function refreshListings() {
    const q = query(listingsRef, orderBy("created", "desc"));
    const snapshot = await getDocs(q);
    const posts = [];
    snapshot.forEach(docSnap => {
        posts.push({ ...docSnap.data(), id: docSnap.id });
    });
    renderBoard(posts);
}

// Check if user is logged in (using localStorage to match login.html)
// Check for wishboard_user_id first (set by login.html), then fallback to wishboard_user
const userId = localStorage.getItem('wishboard_user_id');
const userName = localStorage.getItem('wishboard_user');
const loginBtn = document.getElementById('loginBtn');

if (!userId && !userName) {
    // User not logged in - show login button
    if (loginBtn) loginBtn.style.display = 'block';
    showLogin();
} else {
    // User is logged in - hide login button
    if (loginBtn) loginBtn.style.display = 'none';
    updateCurrentUser();
}
</script>
</body>
    <script>
    // Depop-style price input: right-to-left entry
    const priceInput = document.getElementById('price');
    if (priceInput) {
        let priceValue = '';
        priceInput.addEventListener('keydown', function(e) {
            // Allow navigation keys
            if (["ArrowLeft","ArrowRight","Tab"].includes(e.key)) return;
            // Prevent default for all but numbers and backspace
            if (!/^[0-9]$/.test(e.key) && e.key !== 'Backspace') {
                e.preventDefault();
                return;
            }
            e.preventDefault();
            if (/^[0-9]$/.test(e.key)) {
                // Add digit to left
                priceValue = priceValue + e.key;
            } else if (e.key === 'Backspace') {
                // Remove last digit
                priceValue = priceValue.slice(0, -1);
            }
            // Format as cents
            let num = priceValue ? parseInt(priceValue, 10) : 0;
            let formatted = (num / 100).toFixed(2);
            priceInput.value = formatted;
        });
        priceInput.addEventListener('focus', function() {
            priceInput.select();
        });
        priceInput.addEventListener('blur', function() {
            if (!priceInput.value) priceInput.value = '0.00';
        });
    }
    </script>
</html>